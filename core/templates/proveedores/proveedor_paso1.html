{% extends 'base.html' %}

{% block title %}Paso 1: Identificaci√≥n - Dulcer√≠a Lilis{% endblock %}

{% block extra_css %}
<style>
  :root {
    --primary: #ff0000;
    --primary-dark: #cc0000;
    --text-dark: #1f2937;
    --text-gray: #6b7280;
    --border: #e5e7eb;
    --shadow: rgba(15, 23, 42, 0.08);
  }
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }
  .page-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-dark);
    margin: 0;
  }
  .btn-secondary {
    background: #f8fafc;
    color: var(--text-dark);
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.25s ease;
    box-shadow: 0 4px 20px rgba(15, 23, 42, 0.05);
  }
  .btn-secondary:hover {
    background: #e2e8f0;
  }
  .btn-primary {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: #fff;
    padding: 0.9rem 1.8rem;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.25s ease;
    box-shadow: 0 10px 24px rgba(220, 38, 38, 0.35);
  }
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 14px 30px rgba(220, 38, 38, 0.45);
  }
  .steps-progress {
    background: #fff;
    border-radius: 16px;
    padding: 1.75rem;
    box-shadow: 0 12px 40px rgba(15, 23, 42, 0.08);
    margin-bottom: 2rem;
  }
  .steps-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
  }
  .progress-line {
    position: absolute;
    top: 22px;
    left: 40px;
    right: 40px;
    height: 4px;
    background: #e2e8f0;
    z-index: 1;
  }
  .progress-line-fill {
    height: 100%;
    background: linear-gradient(90deg, rgba(255,0,0,0.45), var(--primary));
    width: {{ progreso|default:'0%' }};
    transition: width 0.5s ease;
  }
  .step-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.55rem;
    flex: 1;
    position: relative;
    z-index: 2;
  }
  .step-number {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    background: #e2e8f0;
    color: #64748b;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.1rem;
    transition: all 0.3s ease;
  }
  .step-item.active .step-number {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: #fff;
    box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
  }
  .step-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: #94a3b8;
  }
  .step-item.active .step-label {
    color: var(--primary-dark);
  }
  .form-container {
    background: #fff;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 12px 40px rgba(15, 23, 42, 0.08);
  }
  .form-section {
    margin-bottom: 2rem;
  }
  .section-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 1.5rem;
  }
  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.4rem;
  }
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.45rem;
  }
  .form-label {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 0.35rem;
  }
  .form-label .tag {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 0.15rem 0.5rem;
    border-radius: 999px;
    background: #e2e8f0;
    color: #475569;
  }
  .form-input,
  .form-container input {
    padding: 0.85rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 0.95rem;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    background: #f8fafc;
  }
  .form-container input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(255, 0, 0, 0.15);
    background: #fff;
  }
  .errorlist {
    margin: 0;
    padding-left: 1rem;
    font-size: 0.8rem;
    color: #dc2626;
    list-style: disc;
  }
  .form-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    padding-top: 1.75rem;
    border-top: 1px solid #e2e8f0;
  }
  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    .form-actions {
      flex-direction: column;
      align-items: stretch;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">Crear Proveedor ¬∑ Paso 1</h1>
  <a href="{% url 'core:lista_proveedores' %}" class="btn-secondary">‚Üê Volver</a>
</div>

<div class="steps-progress">
  <div class="steps-header">
    <div class="progress-line">
      <div class="progress-line-fill"></div>
    </div>
    <div class="step-item active">
      <div class="step-number">1</div>
      <div class="step-label">Identificaci√≥n y contacto</div>
    </div>
    <div class="step-item">
      <div class="step-number">2</div>
      <div class="step-label">Direcci√≥n y comercial</div>
    </div>
    <div class="step-item">
      <div class="step-number">3</div>
      <div class="step-label">Relaci√≥n con productos</div>
    </div>
  </div>
</div>

<form method="post" class="form-container" id="proveedorForm" novalidate>
  {% csrf_token %}
  {{ form.non_field_errors }}

  <div class="form-section">
    <h2 class="section-title">Identificaci√≥n legal y contacto</h2>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">id (PK)</label>
        <input type="text" value="(autogenerado)" class="form-input" disabled>
      </div>
      <div class="form-group">
        <label class="form-label" for="{{ form.rut.id_for_label }}">
          rut_nif (√∫nico)
        </label>
        {{ form.rut }}
        {{ form.rut.errors }}
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label" for="{{ form.razon_social.id_for_label }}">
          razon_social (requerido)
        </label>
        {{ form.razon_social }}
        {{ form.razon_social.errors }}
      </div>
      <div class="form-group">
        <label class="form-label" for="{{ form.nombre_fantasia.id_for_label }}">
          nombre_fantasia (opcional)
        </label>
        {{ form.nombre_fantasia }}
        {{ form.nombre_fantasia.errors }}
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label" for="{{ form.email.id_for_label }}">
          email (requerido)
        </label>
        {{ form.email }}
        {{ form.email.errors }}
      </div>
      <div class="form-group">
        <label class="form-label" for="{{ form.telefono.id_for_label }}">
          telefono (opcional)
        </label>
        {{ form.telefono }}
        {{ form.telefono.errors }}
      </div>
      <div class="form-group">
        <label class="form-label" for="{{ form.sitio_web.id_for_label }}">
          sitio_web (opcional)
        </label>
        {{ form.sitio_web }}
        {{ form.sitio_web.errors }}
      </div>
    </div>
  </div>

  <div class="form-actions">
    <a href="{% url 'core:lista_proveedores' %}" class="btn-secondary">‚Üê Cancelar</a>
    <button type="submit" class="btn-primary">Siguiente: Direcci√≥n ‚Üí</button>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// ============================================
// PROVEEDOR PASO 1 - VALIDACIONES Y SWEETALERTS PRO
// ============================================

// Toast personalizado
const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true,
    didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer)
        toast.addEventListener('mouseleave', Swal.resumeTimer)
    }
});

// Mensaje de bienvenida
document.addEventListener('DOMContentLoaded', function() {
    Swal.fire({
        icon: 'info',
        title: 'üè¢ Nuevo Proveedor',
        html: '<p>Complete la informaci√≥n de identificaci√≥n y contacto</p><small style="color: #6B7280;">Paso 1 de 3</small>',
        timer: 3000,
        showConfirmButton: false,
        toast: true,
        position: 'top-end',
        background: '#FEE2E2',
        iconColor: '#ff0000'
    });
});

// Validaci√≥n de RUT chileno mejorada
function validarRut(valor) {
    if (!valor) return false;
    const limpio = valor.replace(/\./g, '').replace(/-/g, '').toUpperCase();
    if (limpio.length < 2) return false;
    const rutRegex = /^[0-9]+-[0-9K]$/;
    if (!rutRegex.test(valor.replace(/\./g, ''))) return false;
    const cuerpo = limpio.slice(0, -1);
    const dv = limpio.slice(-1);
    if (!/^\d+$/.test(cuerpo)) return false;
    let suma = 0;
    let multiplo = 2;
    for (let i = cuerpo.length - 1; i >= 0; i--) {
        suma += parseInt(cuerpo[i], 10) * multiplo;
        multiplo = multiplo === 7 ? 2 : multiplo + 1;
    }
    const resto = 11 - (suma % 11);
    const dvEsperado = resto === 11 ? '0' : resto === 10 ? 'K' : `${resto}`;
    return dvEsperado === dv;
}

// Formatear RUT mientras se escribe
function formatearRut(valor) {
    let limpio = valor.replace(/\./g, '').replace(/-/g, '').toUpperCase();
    if (limpio.length <= 1) return limpio;
    const cuerpo = limpio.slice(0, -1);
    const dv = limpio.slice(-1);
    const cuerpoFormateado = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return `${cuerpoFormateado}-${dv}`;
}

// Validaci√≥n de email
function validarEmail(valor) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(valor);
}

// Validaci√≥n de tel√©fono chileno
function validarTelefono(valor) {
    if (!valor) return true;
    const telRegex = /^(\+?56)?(\s?)(0?9)(\s?)\d{4}(\s?)\d{4}$/;
    return telRegex.test(valor);
}

// Validaci√≥n de URL
function validarURL(valor) {
    if (!valor) return true;
    try {
        const url = new URL(valor);
        return url.protocol === 'http:' || url.protocol === 'https:';
    } catch (e) {
        return false;
    }
}

// Referencias a los campos
const rutInput = document.getElementById('{{ form.rut.id_for_label }}');
const razonInput = document.getElementById('{{ form.razon_social.id_for_label }}');
const nombreFantasiaInput = document.getElementById('{{ form.nombre_fantasia.id_for_label }}');
const emailInput = document.getElementById('{{ form.email.id_for_label }}');
const telefonoInput = document.getElementById('{{ form.telefono.id_for_label }}');
const sitioWebInput = document.getElementById('{{ form.sitio_web.id_for_label }}');

// VALIDACI√ìN DE RUT
if (rutInput) {
    rutInput.addEventListener('input', function(e) {
        let valor = e.target.value.replace(/\./g, '').replace(/-/g, '').toUpperCase();
        valor = valor.replace(/[^0-9K]/g, '');
        if (valor.length > 9) valor = valor.substring(0, 9);
        if (valor.length >= 2) {
            e.target.value = formatearRut(valor);
        } else {
            e.target.value = valor;
        }
        if (valor.length >= 2 && validarRut(e.target.value)) {
            e.target.style.borderColor = '#10B981';
            e.target.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
        } else if (valor.length > 0) {
            e.target.style.borderColor = '#F59E0B';
            e.target.style.boxShadow = '0 0 0 3px rgba(245, 158, 11, 0.1)';
        } else {
            e.target.style.borderColor = 'var(--border)';
            e.target.style.boxShadow = '';
        }
    });
    rutInput.addEventListener('blur', function(e) {
        const valor = e.target.value.trim();
        if (valor && !validarRut(valor)) {
            Swal.fire({
                icon: 'error',
                title: '‚ùå RUT inv√°lido',
                html: `
                    <div style="text-align: center; margin: 1rem 0;">
                        <p style="margin-bottom: 1rem;">El RUT ingresado no es v√°lido</p>
                        <div style="background: #F3F4F6; padding: 1rem; border-radius: 8px;">
                            <strong style="color: #1F2937;">Formato correcto:</strong>
                            <div style="color: #10B981; font-size: 1.2rem; font-weight: bold; margin-top: 0.5rem;">
                                12.345.678-9
                            </div>
                        </div>
                    </div>
                `,
                confirmButtonText: 'Corregir',
                confirmButtonColor: '#ff0000'
            });
            e.target.focus();
        } else if (valor && validarRut(valor)) {
            Toast.fire({
                icon: 'success',
                title: '‚úì RUT v√°lido',
                background: '#D1FAE5'
            });
        }
    });
}

// VALIDACI√ìN DE RAZ√ìN SOCIAL
if (razonInput) {
    razonInput.addEventListener('input', function(e) {
        const valor = e.target.value.trim();
        if (valor.length >= 3) {
            e.target.style.borderColor = '#10B981';
            e.target.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
        } else if (valor.length > 0) {
            e.target.style.borderColor = '#F59E0B';
        } else {
            e.target.style.borderColor = 'var(--border)';
            e.target.style.boxShadow = '';
        }
    });
    razonInput.addEventListener('blur', function(e) {
        const valor = e.target.value.trim();
        if (valor && valor.length < 3) {
            Toast.fire({
                icon: 'warning',
                title: '‚ö†Ô∏è Raz√≥n social muy corta',
                text: 'Debe tener al menos 3 caracteres',
                background: '#FEF3C7'
            });
        }
    });
}

// VALIDACI√ìN DE EMAIL
if (emailInput) {
    emailInput.addEventListener('input', function(e) {
        const valor = e.target.value.trim();
        if (validarEmail(valor)) {
            e.target.style.borderColor = '#10B981';
            e.target.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
        } else if (valor.length > 0) {
            e.target.style.borderColor = '#F59E0B';
            e.target.style.boxShadow = '0 0 0 3px rgba(245, 158, 11, 0.1)';
        } else {
            e.target.style.borderColor = 'var(--border)';
            e.target.style.boxShadow = '';
        }
    });
    emailInput.addEventListener('blur', function(e) {
        const valor = e.target.value.trim();
        if (valor && !validarEmail(valor)) {
            Swal.fire({
                icon: 'error',
                title: '‚ùå Email inv√°lido',
                html: `
                    <div style="text-align: center; margin: 1rem 0;">
                        <p style="margin-bottom: 1rem;">El formato del email no es v√°lido</p>
                        <div style="background: #F3F4F6; padding: 1rem; border-radius: 8px;">
                            <strong style="color: #1F2937;">Ejemplo:</strong>
                            <div style="color: #10B981; font-size: 1.2rem; font-weight: bold; margin-top: 0.5rem;">
                                contacto@proveedor.cl
                            </div>
                        </div>
                    </div>
                `,
                confirmButtonText: 'Corregir',
                confirmButtonColor: '#ff0000'
            });
            e.target.focus();
        } else if (valor && validarEmail(valor)) {
            Toast.fire({
                icon: 'success',
                title: '‚úì Email v√°lido',
                background: '#D1FAE5'
            });
        }
    });
}

// VALIDACI√ìN DE TEL√âFONO
if (telefonoInput) {
    telefonoInput.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^\d\s+()-]/g, '');
        const valor = e.target.value.trim();
        if (valor && validarTelefono(valor)) {
            e.target.style.borderColor = '#10B981';
            e.target.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
        } else if (valor.length > 0) {
            e.target.style.borderColor = '#F59E0B';
        } else {
            e.target.style.borderColor = 'var(--border)';
            e.target.style.boxShadow = '';
        }
    });
    telefonoInput.addEventListener('blur', function(e) {
        const valor = e.target.value.trim();
        if (valor && !validarTelefono(valor)) {
            Toast.fire({
                icon: 'warning',
                title: 'üì± Formato de tel√©fono',
                text: 'Formato sugerido: +56 9 1234 5678',
                background: '#FEF3C7'
            });
        }
    });
}

// VALIDACI√ìN DE SITIO WEB
if (sitioWebInput) {
    sitioWebInput.addEventListener('input', function(e) {
        const valor = e.target.value.trim();
        if (valor && validarURL(valor)) {
            e.target.style.borderColor = '#10B981';
            e.target.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
        } else if (valor.length > 0) {
            e.target.style.borderColor = '#F59E0B';
        } else {
            e.target.style.borderColor = 'var(--border)';
            e.target.style.boxShadow = '';
        }
    });
    sitioWebInput.addEventListener('blur', function(e) {
        const valor = e.target.value.trim();
        if (valor && !validarURL(valor)) {
            Toast.fire({
                icon: 'info',
                title: 'üåê Formato de URL',
                text: 'Debe comenzar con http:// o https://',
                background: '#DBEAFE'
            });
        }
    });
}

// VALIDACI√ìN PRINCIPAL DEL FORMULARIO
const form = document.getElementById('proveedorForm');
if (form) {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const rut = rutInput.value.trim();
        const razon = razonInput.value.trim();
        const email = emailInput.value.trim();
        const telefono = telefonoInput ? telefonoInput.value.trim() : '';
        const sitioWeb = sitioWebInput ? sitioWebInput.value.trim() : '';
        const nombreFantasia = nombreFantasiaInput ? nombreFantasiaInput.value.trim() : '';
        let camposFaltantes = [];
        let primerCampoError = null;

        // Validar RUT (obligatorio)
        if (!rut) {
            camposFaltantes.push('üÜî RUT/NIF del proveedor');
            if (!primerCampoError) primerCampoError = rutInput;
        } else if (!validarRut(rut)) {
            Swal.fire({
                icon: 'error',
                title: '‚ùå RUT inv√°lido',
                html: `
                    <div style="text-align: center; margin: 1.5rem 0;">
                        <div style="background: #FEE2E2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <strong style="color: #DC2626;">RUT ingresado:</strong>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #DC2626; margin-top: 0.5rem;">
                                ${rut}
                            </div>
                        </div>
                        <div style="background: #D1FAE5; padding: 1rem; border-radius: 8px;">
                            <strong style="color: #10B981;">Formato correcto:</strong>
                            <div style="font-size: 1.3rem; font-weight: bold; color: #10B981; margin-top: 0.5rem;">
                                12.345.678-9
                            </div>
                        </div>
                    </div>
                `,
                confirmButtonText: 'Corregir',
                confirmButtonColor: '#ff0000'
            });
            rutInput.focus();
            return;
        }

        // Validar Raz√≥n Social (obligatorio)
        if (!razon) {
            camposFaltantes.push('üè¢ Raz√≥n Social');
            if (!primerCampoError) primerCampoError = razonInput;
        } else if (razon.length < 3) {
            Swal.fire({
                icon: 'error',
                title: '‚ùå Raz√≥n Social inv√°lida',
                html: '<p>La raz√≥n social debe tener <strong>al menos 3 caracteres</strong></p>',
                confirmButtonText: 'Corregir',
                confirmButtonColor: '#ff0000'
            });
            razonInput.focus();
            return;
        }

        // Validar Email (obligatorio)
        if (!email) {
            camposFaltantes.push('üìß Email de contacto');
            if (!primerCampoError) primerCampoError = emailInput;
        } else if (!validarEmail(email)) {
            Swal.fire({
                icon: 'error',
                title: '‚ùå Email inv√°lido',
                html: `
                    <div style="text-align: center; margin: 1.5rem 0;">
                        <p style="margin-bottom: 1rem;">El formato del email no es correcto</p>
                        <div style="background: #F3F4F6; padding: 1rem; border-radius: 8px;">
                            <strong style="color: #1F2937;">Ejemplos v√°lidos:</strong>
                            <div style="margin-top: 0.5rem; color: #10B981;">
                                ‚Ä¢ contacto@empresa.cl<br>
                                ‚Ä¢ ventas@proveedor.com<br>
                                ‚Ä¢ admin@negocio.co
                            </div>
                        </div>
                    </div>
                `,
                confirmButtonText: 'Corregir',
                confirmButtonColor: '#ff0000'
            });
            emailInput.focus();
            return;
        }

        // Mostrar campos faltantes
        if (camposFaltantes.length > 0) {
            let listaCampos = '<ul style="text-align: left; margin: 1rem 0; padding-left: 1.5rem;">';
            camposFaltantes.forEach(campo => {
                listaCampos += `<li style="margin: 0.5rem 0;">${campo}</li>`;
            });
            listaCampos += '</ul>';
            Swal.fire({
                icon: 'error',
                title: '‚ùå Campos obligatorios faltantes',
                html: `
                    <p style="margin-bottom: 1rem;">Complete los siguientes campos:</p>
                    ${listaCampos}
                    <div style="background: #FEE2E2; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                        <strong style="color: #DC2626;">Total: ${camposFaltantes.length} campo${camposFaltantes.length !== 1 ? 's' : ''}</strong>
                    </div>
                `,
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#ff0000',
                width: '600px',
                willClose: () => {
                    if (primerCampoError) {
                        primerCampoError.focus();
                        primerCampoError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            });
            return;
        }

        // Validar campos opcionales si tienen valor
        if (telefono && !validarTelefono(telefono)) {
            Swal.fire({
                icon: 'warning',
                title: 'üì± Formato de tel√©fono',
                html: `
                    <div style="text-align: center; margin: 1rem 0;">
                        <p>El formato del tel√©fono no es el esperado</p>
                        <div style="background: #FEF3C7; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <strong>Formato sugerido:</strong>
                            <div style="color: #F59E0B; font-weight: bold; margin-top: 0.5rem;">
                                +56 9 1234 5678
                            </div>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Corregir',
                cancelButtonText: 'Continuar de todas formas',
                confirmButtonColor: '#ff0000',
                cancelButtonColor: '#6B7280'
            }).then((result) => {
                if (result.isConfirmed) {
                    telefonoInput.focus();
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    mostrarConfirmacionFinal(rut, razon, email, nombreFantasia, telefono, sitioWeb);
                }
            });
            return;
        }

        if (sitioWeb && !validarURL(sitioWeb)) {
            Swal.fire({
                icon: 'warning',
                title: 'üåê URL del sitio web',
                html: `
                    <div style="text-align: center; margin: 1rem 0;">
                        <p>La URL debe comenzar con http:// o https://</p>
                        <div style="background: #DBEAFE; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <strong>Ejemplos:</strong>
                            <div style="color: #2563EB; font-weight: bold; margin-top: 0.5rem;">
                                https://www.proveedor.cl<br>
                                http://empresa.com
                            </div>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Corregir',
                cancelButtonText: 'Continuar de todas formas',
                confirmButtonColor: '#ff0000',
                cancelButtonColor: '#6B7280'
            }).then((result) => {
                if (result.isConfirmed) {
                    sitioWebInput.focus();
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    mostrarConfirmacionFinal(rut, razon, email, nombreFantasia, telefono, sitioWeb);
                }
            });
            return;
        }

        // Todo correcto
        mostrarConfirmacionFinal(rut, razon, email, nombreFantasia, telefono, sitioWeb);
    });
}

// CONFIRMACI√ìN FINAL
function mostrarConfirmacionFinal(rut, razon, email, nombreFantasia, telefono, sitioWeb) {
    let resumenHTML = `
        <div style="text-align: left; margin: 1.5rem 0; font-size: 0.95rem;">
            <div style="background: #F9FAFB; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <p style="margin: 0.5rem 0;"><strong>üÜî RUT:</strong> ${rut}</p>
                <p style="margin: 0.5rem 0;"><strong>üè¢ Raz√≥n Social:</strong> ${razon}</p>
                ${nombreFantasia ? `<p style="margin: 0.5rem 0;"><strong>üè∑Ô∏è Nombre Fantas√≠a:</strong> ${nombreFantasia}</p>` : ''}
            </div>
            <div style="display: grid; gap: 0.75rem;">
                <div style="background: #DBEAFE; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #2563EB;">
                    <strong style="color: #1F2937;">üìß Email:</strong>
                    <span style="color: #2563EB; font-weight: bold;">${email}</span>
                </div>
    `;
    if (telefono) {
        resumenHTML += `
                <div style="background: #D1FAE5; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #10B981;">
                    <strong style="color: #1F2937;">üì± Tel√©fono:</strong>
                    <span style="color: #10B981; font-weight: bold;">${telefono}</span>
                </div>
        `;
    }
    if (sitioWeb) {
        resumenHTML += `
                <div style="background: #FEF3C7; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #F59E0B;">
                    <strong style="color: #1F2937;">üåê Sitio Web:</strong>
                    <span style="color: #F59E0B; font-weight: bold; font-size: 0.85em;">${sitioWeb}</span>
                </div>
        `;
    }
    resumenHTML += `
            </div>
        </div>
    `;
    Swal.fire({
        icon: 'question',
        title: '¬øGuardar y continuar al Paso 2?',
        html: `
            <p style="color: #6B7280; margin-bottom: 1rem;">
                Se guardar√° la informaci√≥n de identificaci√≥n y contacto
            </p>
            ${resumenHTML}
        `,
        showCancelButton: true,
        confirmButtonText: '‚úì Continuar al Paso 2 ‚Üí',
        cancelButtonText: '‚Üê Revisar datos',
        confirmButtonColor: '#ff0000',
        cancelButtonColor: '#6B7280',
        width: '600px',
        backdrop: `rgba(255, 0, 0, 0.1)`
    }).then((result) => {
        if (result.isConfirmed) {
            guardarPaso1();
        }
    });
}

function guardarPaso1() {
    let progreso = 0;
    Swal.fire({
        title: 'üíæ Guardando Paso 1...',
        html: `
            <div style="margin: 1.5rem 0;">
                <p style="color: #6B7280; margin-bottom: 1rem;">Procesando informaci√≥n del proveedor</p>
                <div style="background: #F3F4F6; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div id="progressBar" style="background: linear-gradient(90deg, #ff0000, #cc0000); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <p id="progressText" style="color: #ff0000; margin-top: 0.5rem; font-weight: bold;">0%</p>
            </div>
        `,
        showConfirmButton: false,
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const interval = setInterval(() => {
                progreso += 10;
                progressBar.style.width = progreso + '%';
                progressText.textContent = progreso + '%';
                if (progreso >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        form.submit();
                    }, 500);
                }
            }, 100);
        }
    });
}
</script>
{% endblock %}