{% extends 'base.html' %}

{% block title %}
    Paso 3: Relaci√≥n con Productos - Dulcer√≠a Lilis
{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 2rem;
        color: var(--text-dark);
        font-weight: 700;
    }

    .steps-progress {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 12px var(--shadow);
        margin-bottom: 2rem;
    }

    .steps-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
    }

    .step-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
        position: relative;
        z-index: 2;
    }

    .step-number {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: var(--border);
        color: var(--text-gray);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.2rem;
        transition: all 0.3s ease;
    }

    .step-item.completed .step-number {
        background: #4CAF50;
        color: white;
    }

    .step-item.active .step-number {
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        50% {
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.6);
        }
    }

    .step-label {
        font-size: 0.85rem;
        color: var(--text-gray);
        font-weight: 600;
        text-align: center;
    }

    .step-item.active .step-label {
        color: #4CAF50;
        font-weight: 700;
    }

    .progress-line {
        position: absolute;
        top: 22px;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--border);
        z-index: 1;
    }

    .progress-line-fill {
        height: 100%;
        background: linear-gradient(90deg, #4CAF50 0%, #45a049 100%);
        width: 100%;
        transition: width 0.5s ease;
    }

    .form-container {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 12px var(--shadow);
    }

    .form-section {
        margin-bottom: 2rem;
    }

    .section-title {
        font-size: 1.3rem;
        color: var(--text-dark);
        font-weight: 700;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    label {
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.95rem;
    }

    .optional {
        color: var(--text-gray);
        font-weight: 400;
        font-size: 0.85rem;
        margin-left: 0.3rem;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
        padding: 0.9rem;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
        outline: none;
        border-color: #4CAF50;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        padding: 1rem;
        background: #E8F5E9;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent;
    }

    .checkbox-group:hover {
        background: #C8E6C9;
        border-color: #4CAF50;
    }

    .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #4CAF50;
    }

    .checkbox-group label {
        margin: 0;
        cursor: pointer;
        flex: 1;
    }

    .info-box {
        background: #E8F5E9;
        border-left: 4px solid #4CAF50;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }

    .info-box p {
        margin: 0;
        color: #2E7D32;
        font-size: 0.95rem;
    }

    .productos-table {
        border: 2px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
    }

    .productos-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .productos-table thead {
        background: #F5F5F5;
    }

    .productos-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.9rem;
        border-bottom: 2px solid var(--border);
    }

    .productos-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--border);
    }

    .productos-table tbody tr:last-child td {
        border-bottom: none;
    }

    .btn-add {
        background: #E8F5E9;
        color: #2E7D32;
        padding: 0.8rem 1.5rem;
        border: 2px dashed #4CAF50;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .btn-add:hover {
        background: #4CAF50;
        color: white;
        border-style: solid;
    }

    .form-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid var(--border);
    }

    .btn-secondary {
        background: #f5f5f5;
        color: var(--text-dark);
        padding: 0.9rem 1.8rem;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }

    .btn-secondary:hover {
        background: #e0e0e0;
    }

    .btn-success {
        background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
        color: white;
        padding: 0.9rem 1.8rem;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }

    /* Estilos personalizados para SweetAlert2 */
    .swal2-popup {
        border-radius: 16px;
        font-family: inherit;
    }

    .swal2-title {
        color: var(--text-dark);
        font-size: 1.5rem;
    }

    .swal2-html-container {
        color: var(--text-gray);
    }

    .swal2-confirm {
        background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%) !important;
        border-radius: 8px;
        padding: 0.6rem 2rem;
        font-weight: 600;
    }

    .swal2-cancel {
        background: #f5f5f5 !important;
        color: var(--text-dark) !important;
        border-radius: 8px;
        padding: 0.6rem 2rem;
        font-weight: 600;
    }

    .swal-error-list {
        text-align: left;
        margin: 0;
        padding-left: 1.2rem;
    }

    .swal-error-list li {
        margin-bottom: 0.3rem;
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .productos-table {
            overflow-x: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Crear Proveedor - Paso 3</h1>
    <a href="{% url 'core:lista_proveedores' %}" class="btn-secondary">‚Üê Volver</a>
</div>

<div class="steps-progress">
    <div class="steps-header">
        <div class="progress-line">
            <div class="progress-line-fill"></div>
        </div>
        <div class="step-item completed">
            <div class="step-number">‚úì</div>
            <div class="step-label">Identificaci√≥n</div>
        </div>
        <div class="step-item completed">
            <div class="step-number">‚úì</div>
            <div class="step-label">Direcci√≥n</div>
        </div>
        <div class="step-item active">
            <div class="step-number">3</div>
            <div class="step-label">Relaciones</div>
        </div>
    </div>
</div>

<form method="POST" class="form-container" id="proveedorForm" novalidate>
    {% csrf_token %}
    {{ form.non_field_errors }}
    {{ formset.management_form }}

    <div class="form-section">
        <h2 class="section-title">Relaci√≥n con productos</h2>
        
        <div class="info-box">
            <p><strong>Informaci√≥n:</strong> Puedes definir qu√© productos son suministrados por este proveedor, as√≠ como condiciones espec√≠ficas de costo y tiempo de entrega.</p>
        </div>

        <div class="form-row">
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="es_proveedor_preferente" name="es_proveedor_preferente" value="1" {% if data.es_proveedor_preferente %}checked{% endif %}>
                    <label for="es_proveedor_preferente">Marcar como proveedor preferente</label>
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="lead_time">Lead Time (d√≠as) (opcional)</label>
                <input type="number" id="lead_time" name="lead_time" placeholder="7" min="0" value="{{ data.lead_time }}">
            </div>
            
            <div class="form-group">
                <label for="pedido_minimo">Pedido M√≠nimo (opcional)</label>
                <input type="number" id="pedido_minimo" name="pedido_minimo" placeholder="10000" min="0" step="0.01" value="{{ data.pedido_minimo }}">
            </div>
            
            
        </div>
    </div>

    <div class="form-section">
        <h2 class="section-title">Productos asociados</h2>
        
        <div class="productos-table">
            <table id="productosTable">
                <thead>
                    <tr>
                        <th>{{ formset.empty_form.producto.label }}</th>
                        <th>{{ formset.empty_form.costo.label }}</th>
                        <th>{{ formset.empty_form.lead_time.label }} <span class="optional">(opcional)</span></th>
                        <th>{{ formset.empty_form.activo.label }} <span class="optional">(opcional)</span></th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for form_producto in formset.forms %}
                    <tr class="producto-row">
                        <td>{{ form_producto.producto }}</td>
                        <td>{{ form_producto.costo }}</td>
                        <td>{{ form_producto.lead_time }}</td>
                        <td>{{ form_producto.activo }}</td>
                        <td>
                            {% if formset.can_delete %}
                                {{ form_producto.DELETE }} <span class="link-eliminar">Eliminar</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <button type="button" class="btn-add" id="agregarProductoBtn">
            <span>‚ûï</span> Agregar producto
        </button>
    </div>

    <template id="producto-empty-template">
        <tr class="producto-row">
            <td>{{ formset.empty_form.producto }}</td>
            <td>{{ formset.empty_form.costo }}</td>
            <td>{{ formset.empty_form.lead_time }}</td>
            <td>{{ formset.empty_form.activo }}</td>
            <td>
                {% if formset.can_delete %}
                    {{ formset.empty_form.DELETE }} <span class="link-eliminar">Eliminar</span>
                {% endif %}
            </td>
        </tr>
    </template>

    <div class="form-section">
        <h2 class="section-title">Observaciones</h2>
        
        <div class="form-row">
            <div class="form-group full-width">
                <label for="observaciones">Observaciones generales (opcional)</label>
                <textarea id="observaciones" name="observaciones" rows="5" placeholder="Notas adicionales sobre el proveedor, acuerdos especiales, historial, etc.">{{ data.observaciones }}</textarea>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h2 class="section-title">Estado del proveedor</h2>
        
        <div class="form-row">
            <div class="form-group">
                <label for="estado">Estado (requerido)</label>
                {{ form.estado }}
            </div>
        </div>
    </div>

    <div class="form-actions">
        <a href="{% url 'core:proveedor_paso2' %}" class="btn-secondary">‚Üê Anterior</a>
        <button type="submit" class="btn-success">
            <span>‚úì</span> Guardar Proveedor
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// ============================================
// PROVEEDOR PASO 3 - VALIDACIONES Y SWEETALERTS PRO (FINAL)
// ============================================

// Toast personalizado
const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true,
    didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer)
        toast.addEventListener('mouseleave', Swal.resumeTimer)
    }
});

// Mensaje de bienvenida
document.addEventListener('DOMContentLoaded', function() {
    Swal.fire({
        icon: 'success',
        title: 'üéØ Paso Final',
        html: '<p>Configure las relaciones con productos</p><small style="color: #6B7280;">¬°Ya casi terminas!</small>',
        timer: 3000,
        showConfirmButton: false,
        toast: true,
        position: 'top-end',
        background: '#E8F5E9',
        iconColor: '#4CAF50'
    });
});

// ============================================
// GESTI√ìN DIN√ÅMICA DE PRODUCTOS
// ============================================

const formPrefix = 'productos';
const totalForms = document.querySelector(`#id_${formPrefix}-TOTAL_FORMS`);
const tableBody = document.querySelector('#productosTable tbody');
const emptyTemplate = document.getElementById('producto-empty-template');
const agregarBtn = document.getElementById('agregarProductoBtn');

// Agregar producto
if (agregarBtn) {
    agregarBtn.addEventListener('click', function() {
        const formIndex = parseInt(totalForms.value, 10);
        const row = document.createElement('tr');
        row.classList.add('producto-row');
        row.innerHTML = emptyTemplate.innerHTML.replace(/__prefix__/g, formIndex);
        tableBody.appendChild(row);
        totalForms.value = formIndex + 1;
        aplicarValidacionesProducto(row, formIndex);
        Swal.fire({
            icon: 'success',
            title: '‚úì Producto agregado',
            text: 'Complete los datos del producto',
            timer: 2000,
            showConfirmButton: false,
            toast: true,
            position: 'top-end',
            background: '#D1FAE5'
        });
        row.style.opacity = '0';
        row.style.transform = 'translateY(-20px)';
        setTimeout(() => {
            row.style.transition = 'all 0.3s ease';
            row.style.opacity = '1';
            row.style.transform = 'translateY(0)';
        }, 10);
    });
}

// Eliminar producto
if (tableBody) {
    tableBody.addEventListener('click', function(event) {
        if (event.target.classList.contains('link-eliminar') || 
            event.target.closest('.link-eliminar')) {
            const row = event.target.closest('tr');
            const deleteField = row.querySelector('input[name$="-DELETE"]');
            if (deleteField) {
                Swal.fire({
                    icon: 'warning',
                    title: '¬øEliminar producto?',
                    text: 'Esta acci√≥n no se puede deshacer',
                    showCancelButton: true,
                    confirmButtonText: 'S√≠, eliminar',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#DC2626',
                    cancelButtonColor: '#6B7280'
                }).then((result) => {
                    if (result.isConfirmed) {
                        deleteField.checked = true;
                        row.style.transition = 'all 0.3s ease';
                        row.style.opacity = '0';
                        row.style.transform = 'translateX(-20px)';
                        setTimeout(() => {
                            row.style.display = 'none';
                        }, 300);
                        Toast.fire({
                            icon: 'info',
                            title: 'Producto marcado para eliminar',
                            background: '#F3F4F6'
                        });
                    }
                });
            }
        }
    });
}

// ============================================
// VALIDACIONES DE PRODUCTOS
// ============================================

function aplicarValidacionesProducto(row, index) {
    const costoInput = row.querySelector(`input[name="productos-${index}-costo"]`);
    const leadTimeInput = row.querySelector(`input[name="productos-${index}-lead_time"]`);
    const productoSelect = row.querySelector(`select[name="productos-${index}-producto"]`);
    // Validaci√≥n de costo
    if (costoInput) {
        costoInput.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^\d.]/g, '');
            const partes = e.target.value.split('.');
            if (partes.length > 2) {
                e.target.value = partes[0] + '.' + partes.slice(1).join('');
            }
            if (partes[1] && partes[1].length > 2) {
                e.target.value = partes[0] + '.' + partes[1].substring(0, 2);
            }
            const valor = parseFloat(e.target.value);
            if (valor > 0 && valor < 1000000) {
                e.target.style.borderColor = '#10B981';
                e.target.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
            } else if (valor >= 1000000) {
                e.target.style.borderColor = '#F59E0B';
            } else {
                e.target.style.borderColor = 'var(--border)';
                e.target.style.boxShadow = '';
            }
        });
        costoInput.addEventListener('blur', function(e) {
            const valor = parseFloat(e.target.value);
            if (e.target.value && valor <= 0) {
                Toast.fire({
                    icon: 'error',
                    title: '‚ùå Costo inv√°lido',
                    text: 'El costo debe ser mayor a 0',
                    background: '#FEE2E2'
                });
                e.target.focus();
            } else if (valor > 10000000) {
                Swal.fire({
                    icon: 'warning',
                    title: 'üí∞ Costo muy alto',
                    html: `
                        <div style="text-align: center; margin: 1rem 0;">
                            <div style="background: #FEF3C7; padding: 1rem; border-radius: 8px;">
                                <strong style="color: #92400E;">Costo: $${valor.toLocaleString('es-CL')}</strong>
                                <p style="margin-top: 0.5rem; color: #6B7280;">
                                    Verifica que el costo sea correcto
                                </p>
                            </div>
                        </div>
                    `,
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#4CAF50'
                });
            }
        });
    }
    // Validaci√≥n de lead time
    if (leadTimeInput) {
        leadTimeInput.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^\d]/g, '');
            const valor = parseInt(e.target.value) || 0;
            if (valor > 0 && valor <= 30) {
                e.target.style.borderColor = '#10B981';
                e.target.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
            } else if (valor > 30 && valor <= 90) {
                e.target.style.borderColor = '#F59E0B';
            } else if (valor > 90) {
                e.target.style.borderColor = '#DC2626';
            } else {
                e.target.style.borderColor = 'var(--border)';
                e.target.style.boxShadow = '';
            }
        });
        leadTimeInput.addEventListener('blur', function(e) {
            const valor = parseInt(e.target.value) || 0;
            if (valor > 90) {
                Toast.fire({
                    icon: 'warning',
                    title: '‚ö†Ô∏è Lead time largo',
                    text: `${valor} d√≠as puede afectar la disponibilidad`,
                    background: '#FEF3C7'
                });
            }
        });
    }
    // Notificaci√≥n al seleccionar producto
    if (productoSelect) {
        productoSelect.addEventListener('change', function(e) {
            if (e.target.value) {
                const productoTexto = e.target.options[e.target.selectedIndex].text;
                Toast.fire({
                    icon: 'success',
                    title: `üì¶ ${productoTexto}`,
                    text: 'Producto seleccionado',
                    background: '#D1FAE5'
                });
            }
        });
    }
}

// Aplicar validaciones a productos existentes
document.addEventListener('DOMContentLoaded', function() {
    const rows = tableBody.querySelectorAll('.producto-row');
    rows.forEach((row, index) => {
        aplicarValidacionesProducto(row, index);
    });
});

// ============================================
// VALIDACIONES DE CAMPOS GENERALES
// ============================================

const esPreferenteCheck = document.getElementById('es_proveedor_preferente');
const leadTimeGeneralInput = document.getElementById('lead_time');
const pedidoMinimoInput = document.getElementById('pedido_minimo');
const observacionesInput = document.getElementById('observaciones');
const estadoSelect = document.getElementById('estado');

// Proveedor preferente
if (esPreferenteCheck) {
    esPreferenteCheck.addEventListener('change', function(e) {
        if (e.target.checked) {
            Swal.fire({
                icon: 'info',
                title: '‚≠ê Proveedor Preferente',
                html: '<p>Este proveedor ser√° priorizado en las √≥rdenes de compra</p>',
                timer: 3000,
                showConfirmButton: false,
                toast: true,
                position: 'top-end',
                background: '#FEF3C7',
                iconColor: '#F59E0B'
            });
        }
    });
}

// Lead time general
if (leadTimeGeneralInput) {
    leadTimeGeneralInput.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^\d]/g, '');
        const valor = parseInt(e.target.value) || 0;
        if (valor > 0 && valor <= 30) {
            e.target.style.borderColor = '#10B981';
        } else if (valor > 30 && valor <= 90) {
            e.target.style.borderColor = '#F59E0B';
        } else if (valor > 90) {
            e.target.style.borderColor = '#DC2626';
        } else {
            e.target.style.borderColor = 'var(--border)';
        }
    });
    leadTimeGeneralInput.addEventListener('blur', function(e) {
        const valor = parseInt(e.target.value) || 0;
        if (valor > 60) {
            Toast.fire({
                icon: 'warning',
                title: `‚è±Ô∏è ${valor} d√≠as de lead time`,
                text: 'Considere este tiempo en sus planificaciones',
                background: '#FEF3C7'
            });
        }
    });
}

// Pedido m√≠nimo
if (pedidoMinimoInput) {
    pedidoMinimoInput.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^\d.]/g, '');
        const partes = e.target.value.split('.');
        if (partes.length > 2) {
            e.target.value = partes[0] + '.' + partes.slice(1).join('');
        }
        if (partes[1] && partes[1].length > 2) {
            e.target.value = partes[0] + '.' + partes[1].substring(0, 2);
        }
        const valor = parseFloat(e.target.value);
        if (valor > 0 && valor < 100000) {
            e.target.style.borderColor = '#10B981';
        } else if (valor >= 100000) {
            e.target.style.borderColor = '#F59E0B';
        } else {
            e.target.style.borderColor = 'var(--border)';
        }
    });
    pedidoMinimoInput.addEventListener('blur', function(e) {
        const valor = parseFloat(e.target.value);
        if (valor > 1000000) {
            Toast.fire({
                icon: 'info',
                title: 'üí∞ Pedido m√≠nimo alto',
                text: `$${valor.toLocaleString('es-CL')} es un monto considerable`,
                background: '#DBEAFE'
            });
        }
    });
}

// Estado
if (estadoSelect) {
    estadoSelect.addEventListener('change', function(e) {
        const estadoIconos = {
            'ACTIVO': { icon: '‚úÖ', color: '#10B981', bg: '#D1FAE5', texto: 'Proveedor activo' },
            'INACTIVO': { icon: '‚è∏Ô∏è', color: '#6B7280', bg: '#F3F4F6', texto: 'Proveedor inactivo' },
            'SUSPENDIDO': { icon: 'üö´', color: '#DC2626', bg: '#FEE2E2', texto: 'Proveedor suspendido' }
        };
        const info = estadoIconos[e.target.value];
        if (info) {
            Toast.fire({
                icon: 'info',
                title: `${info.icon} ${info.texto}`,
                background: info.bg
            });
        }
    });
}

// ============================================
// VALIDACI√ìN PRINCIPAL DEL FORMULARIO
// ============================================

const form = document.getElementById('proveedorForm');
if (form) {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const estado = estadoSelect.value;
        const leadTime = leadTimeGeneralInput.value.trim();
        const pedidoMinimo = pedidoMinimoInput.value.trim();
        const esPreferente = esPreferenteCheck.checked;
        const errores = [];
        const productosValidos = [];
        tableBody.querySelectorAll('.producto-row').forEach((row, index) => {
            if (row.style.display === 'none') return;
            const deleteField = row.querySelector('input[name$="-DELETE"]');
            if (deleteField && deleteField.checked) return;
            const select = row.querySelector('select[name$="-producto"]');
            const costo = row.querySelector('input[name$="-costo"]');
            const lead = row.querySelector('input[name$="-lead_time"]');
            const numeroFila = index + 1;
            const valorProducto = select ? select.value.trim() : '';
            const valorCosto = costo ? costo.value.trim() : '';
            const valorLead = lead ? lead.value.trim() : '';
            const filaVacia = !valorProducto && 
                (valorCosto === '' || Number(valorCosto) === 0) && 
                (valorLead === '' || Number(valorLead) === 0);
            if (filaVacia) return;
            if (!valorProducto) {
                errores.push(`Producto #${numeroFila}: selecciona un producto`);
            }
            if (valorCosto === '' || parseFloat(valorCosto) <= 0) {
                errores.push(`Producto #${numeroFila}: ingresa un costo v√°lido mayor a 0`);
            }
            if (valorLead && parseInt(valorLead) < 0) {
                errores.push(`Producto #${numeroFila}: el lead time no puede ser negativo`);
            }
            if (valorProducto && valorCosto && parseFloat(valorCosto) > 0) {
                const productoTexto = select.options[select.selectedIndex].text;
                productosValidos.push({
                    nombre: productoTexto,
                    costo: parseFloat(valorCosto),
                    lead: valorLead || 'No especificado'
                });
            }
        });
        if (errores.length > 0) {
            let listaErrores = '<ul style="text-align: left; margin: 1rem 0; padding-left: 1.5rem;">';
            errores.forEach(error => {
                listaErrores += `<li style="margin: 0.5rem 0; color: #DC2626;">${error}</li>`;
            });
            listaErrores += '</ul>';
            Swal.fire({
                icon: 'error',
                title: '‚ùå Corrige los siguientes errores',
                html: `
                    ${listaErrores}
                    <div style="background: #FEE2E2; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                        <strong style="color: #DC2626;">Total: ${errores.length} error${errores.length !== 1 ? 'es' : ''}</strong>
                    </div>
                `,
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#4CAF50',
                width: '600px'
            });
            return;
        }
        if (leadTime && parseInt(leadTime) < 0) {
            Swal.fire({
                icon: 'error',
                title: '‚ùå Lead time inv√°lido',
                text: 'El lead time no puede ser negativo',
                confirmButtonText: 'Corregir',
                confirmButtonColor: '#4CAF50'
            });
            leadTimeGeneralInput.focus();
            return;
        }
        if (pedidoMinimo && parseFloat(pedidoMinimo) < 0) {
            Swal.fire({
                icon: 'error',
                title: '‚ùå Pedido m√≠nimo inv√°lido',
                text: 'El pedido m√≠nimo no puede ser negativo',
                confirmButtonText: 'Corregir',
                confirmButtonColor: '#4CAF50'
            });
            pedidoMinimoInput.focus();
            return;
        }
        if (!estado) {
            Swal.fire({
                icon: 'error',
                title: '‚ùå Estado requerido',
                text: 'Debe seleccionar el estado del proveedor',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#4CAF50'
            });
            estadoSelect.focus();
            return;
        }
        if (productosValidos.length === 0) {
            Swal.fire({
                icon: 'question',
                title: 'üì¶ Sin productos asociados',
                html: '<p>No has agregado productos a este proveedor</p><p style="color: #6B7280; margin-top: 0.5rem;">¬øDeseas continuar sin productos?</p>',
                showCancelButton: true,
                confirmButtonText: '‚úì S√≠, crear proveedor',
                cancelButtonText: '‚Üê Agregar productos',
                confirmButtonColor: '#4CAF50',
                cancelButtonColor: '#6B7280',
                backdrop: `rgba(76, 175, 80, 0.1)`
            }).then((result) => {
                if (result.isConfirmed) {
                    mostrarConfirmacionFinal(estado, leadTime, pedidoMinimo, esPreferente, productosValidos);
                }
            });
            return;
        }
        mostrarConfirmacionFinal(estado, leadTime, pedidoMinimo, esPreferente, productosValidos);
    });
}

// ============================================
// CONFIRMACI√ìN FINAL
// ============================================

function mostrarConfirmacionFinal(estado, leadTime, pedidoMinimo, esPreferente, productos) {
    const estadoInfo = {
        'ACTIVO': { icon: '‚úÖ', color: '#10B981', texto: 'Activo' },
        'INACTIVO': { icon: '‚è∏Ô∏è', color: '#6B7280', texto: 'Inactivo' },
        'SUSPENDIDO': { icon: 'üö´', color: '#DC2626', texto: 'Suspendido' }
    }[estado] || { icon: '‚ùì', color: '#6B7280', texto: estado };
    let resumenHTML = `
        <div style="text-align: left; margin: 1.5rem 0; font-size: 0.95rem;">
            <h4 style="margin-bottom: 1rem; color: #1F2937;">üìä Informaci√≥n General</h4>
            <div style="display: grid; gap: 0.75rem; margin-bottom: 1.5rem;">
                <div style="background: ${estadoInfo.color}15; padding: 0.75rem; border-radius: 6px; border-left: 3px solid ${estadoInfo.color};">
                    <strong>Estado:</strong> <span style="color: ${estadoInfo.color}; font-weight: bold;">${estadoInfo.icon} ${estadoInfo.texto}</span>
                </div>
    `;
    if (esPreferente) {
        resumenHTML += `
                <div style="background: #FEF3C7; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #F59E0B;">
                    <strong>‚≠ê Proveedor Preferente</strong>
                </div>
        `;
    }
    if (leadTime) {
        const ltNum = parseInt(leadTime);
        const colorLT = ltNum <= 30 ? '#10B981' : ltNum <= 60 ? '#F59E0B' : '#DC2626';
        resumenHTML += `
                <div style="background: ${colorLT}15; padding: 0.75rem; border-radius: 6px; border-left: 3px solid ${colorLT};">
                    <strong>‚è±Ô∏è Lead Time:</strong> <span style="color: ${colorLT}; font-weight: bold;">${leadTime} d√≠as</span>
                </div>
        `;
    }
    if (pedidoMinimo) {
        const pmNum = parseFloat(pedidoMinimo);
        resumenHTML += `
                <div style="background: #DBEAFE; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #2563EB;">
                    <strong>üí∞ Pedido M√≠nimo:</strong> <span style="color: #2563EB; font-weight: bold;">$${pmNum.toLocaleString('es-CL')}</span>
                </div>
        `;
    }
    resumenHTML += '</div>';
    if (productos.length > 0) {
        resumenHTML += `
            <h4 style="margin-bottom: 1rem; color: #1F2937;">üì¶ Productos (${productos.length})</h4>
            <div style="max-height: 200px; overflow-y: auto; background: #F9FAFB; border-radius: 6px; padding: 0.5rem;">
        `;
        productos.forEach((prod, index) => {
            resumenHTML += `
                <div style="padding: 0.5rem; margin: 0.25rem 0; background: white; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                    <span><strong>${index + 1}.</strong> ${prod.nombre}</span>
                    <span style="color: #10B981; font-weight: bold;">$${prod.costo.toLocaleString('es-CL')}</span>
                </div>
            `;
        });
        resumenHTML += '</div>';
    }
    resumenHTML += '</div>';
    Swal.fire({
        icon: 'question',
        title: 'üéâ ¬øCrear proveedor?',
        html: `
            <p style="color: #6B7280; margin-bottom: 1rem;">
                Se guardar√° toda la informaci√≥n de los 3 pasos
            </p>
            ${resumenHTML}
            <div style="background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); padding: 1.5rem; border-radius: 10px; margin-top: 1.5rem; border: 2px solid #4CAF50;">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.5rem;">‚úÖ</span>
                    <strong style="color: #2E7D32; font-size: 1.1rem;">¬øConfirmar creaci√≥n?</strong>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-top: 1rem; font-size: 0.85em;">
                    <div style="text-align: center;">
                        <div style="font-weight: bold; color: #4CAF50;">‚úì Paso 1</div>
                        <div style="color: #6B7280;">Identificaci√≥n</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-weight: bold; color: #4CAF50;">‚úì Paso 2</div>
                        <div style="color: #6B7280;">Direcci√≥n</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-weight: bold; color: #4CAF50;">‚úì Paso 3</div>
                        <div style="color: #6B7280;">Relaciones</div>
                    </div>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '‚úì S√≠, crear proveedor',
        cancelButtonText: '‚Üê Revisar datos',
        confirmButtonColor: '#4CAF50',
        cancelButtonColor: '#6B7280',
        width: '700px',
        backdrop: `rgba(76, 175, 80, 0.1)`
    }).then((result) => {
        if (result.isConfirmed) {
            crearProveedorFinal();
        }
    });
}

// ============================================
// ANIMACI√ìN DE CREACI√ìN FINAL
// ============================================

function crearProveedorFinal() {
    let etapa = 0;
    const etapas = [
        { icono: 'üìù', texto: 'Validando informaci√≥n completa...', progreso: 20 },
        { icono: 'üíæ', texto: 'Creando proveedor en el sistema...', progreso: 40 },
        { icono: 'üìç', texto: 'Guardando ubicaci√≥n...', progreso: 60 },
        { icono: 'üì¶', texto: 'Vinculando productos...', progreso: 80 },
        { icono: '‚úÖ', texto: 'Finalizando registro...', progreso: 100 }
    ];
    Swal.fire({
        title: etapas[0].texto,
        html: `
            <div style="margin: 1.5rem 0;">
                <div style="font-size: 3rem; margin-bottom: 1rem; animation: bounce 0.5s;">
                    ${etapas[0].icono}
                </div>
                <div style="background: #F3F4F6; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div id="progressBar" style="background: linear-gradient(90deg, #4CAF50, #388E3C); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                </div>
                <p style="color: #6B7280; margin-top: 1rem; font-size: 0.9em;">Por favor espere...</p>
            </div>
        `,
        showConfirmButton: false,
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
            const progressBar = document.getElementById('progressBar');
            const intervalo = setInterval(() => {
                if (etapa < etapas.length) {
                    const etapaActual = etapas[etapa];
                    Swal.update({
                        title: etapaActual.texto,
                        html: `
                            <div style="margin: 1.5rem 0;">
                                <div style="font-size: 3rem; margin-bottom: 1rem; animation: bounce 0.5s;">
                                    ${etapaActual.icono}
                                </div>
                                <div style="background: #F3F4F6; height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, #4CAF50, #388E3C); height: 100%; width: ${etapaActual.progreso}%; transition: width 0.5s ease;"></div>
                                </div>
                                <p style="color: #6B7280; margin-top: 1rem; font-size: 0.9em;">${etapaActual.progreso}% completado</p>
                            </div>
                        `
                    });
                    etapa++;
                } else {
                    clearInterval(intervalo);
                    mostrarExito();
                }
            }, 800);
        }
    });
}

function mostrarExito() {
    Swal.fire({
        icon: 'success',
        title: 'üéâ ¬°Proveedor creado exitosamente!',
        html: `
            <div style="margin: 1.5rem 0;">
                <div style="background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); padding: 1.5rem; border-radius: 12px; border: 2px solid #4CAF50;">
                    <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚úÖ</div>
                    <p style="color: #2E7D32; font-size: 1.1rem; margin: 0;">El proveedor ha sido registrado correctamente</p>
                </div>
                <div style="margin-top: 1.5rem; padding: 1rem; background: #F9FAFB; border-radius: 8px;">
                    <p style="color: #6B7280; margin: 0; font-size: 0.9em;">
                        ‚úì Informaci√≥n de identificaci√≥n guardada<br>
                        ‚úì Direcci√≥n y condiciones comerciales configuradas<br>
                        ‚úì Productos vinculados correctamente<br>
                        ‚úì Proveedor listo para usar
                    </p>
                </div>
            </div>
        `,
        confirmButtonText: 'üè¢ Ver lista de proveedores',
        confirmButtonColor: '#4CAF50',
        backdrop: `rgba(76, 175, 80, 0.1)`,
        customClass: {
            popup: 'animate__animated animate__bounceIn',
            confirmButton: 'animate__animated animate__pulse animate__infinite'
        },
        willClose: () => {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes bounce {
                    0%, 100% { transform: translateY(0); }
                    50% { transform: translateY(-20px); }
                }
            `;
            document.head.appendChild(style);
            form.submit();
        }
    });
}

// ============================================
// FUNCI√ìN PARA LIMPIAR FORMULARIO (OPCIONAL)
// ============================================

function limpiarFormulario() {
    Swal.fire({
        icon: 'warning',
        title: 'üîÑ ¬øLimpiar formulario?',
        text: 'Se perder√°n los datos ingresados en este paso',
        showCancelButton: true,
        confirmButtonText: 'S√≠, limpiar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#F59E0B',
        cancelButtonColor: '#6B7280'
    }).then((result) => {
        if (result.isConfirmed) {
            form.reset();
            const rows = tableBody.querySelectorAll('.producto-row');
            rows.forEach((row, index) => {
                if (index > 0) {
                    row.remove();
                }
            });
            if (totalForms) {
                totalForms.value = '1';
            }
            [leadTimeGeneralInput, pedidoMinimoInput].forEach(input => {
                if (input) {
                    input.style.borderColor = 'var(--border)';
                    input.style.boxShadow = '';
                }
            });
            Toast.fire({
                icon: 'success',
                title: '‚úì Formulario limpiado',
                background: '#D1FAE5'
            });
        }
    });
}

// ============================================
// ATAJOS DE TECLADO (OPCIONAL)
// ============================================

document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        form.dispatchEvent(new Event('submit'));
    }
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        if (agregarBtn) {
            agregarBtn.click();
        }
    }
});

// ============================================
// PREVENIR P√âRDIDA DE DATOS
// ============================================

let formModificado = false;

form.addEventListener('input', function() {
    formModificado = true;
});

window.addEventListener('beforeunload', function(e) {
    if (formModificado) {
        e.preventDefault();
        e.returnValue = '';
        return '';
    }
});

form.addEventListener('submit', function() {
    formModificado = false;
});

// ============================================
// VALIDACI√ìN DE PRODUCTOS DUPLICADOS
// ============================================

function validarProductosDuplicados() {
    const productosSeleccionados = new Map();
    let hayDuplicados = false;
    tableBody.querySelectorAll('.producto-row').forEach((row) => {
        if (row.style.display === 'none') return;
        const deleteField = row.querySelector('input[name$="-DELETE"]');
        if (deleteField && deleteField.checked) return;
        const select = row.querySelector('select[name$="-producto"]');
        if (!select || !select.value) return;
        const productoId = select.value;
        const productoNombre = select.options[select.selectedIndex].text;
        if (productosSeleccionados.has(productoId)) {
            hayDuplicados = true;
            select.style.borderColor = '#DC2626';
            select.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.1)';
            Toast.fire({
                icon: 'error',
                title: '‚ö†Ô∏è Producto duplicado',
                text: `"${productoNombre}" ya est√° en la lista`,
                background: '#FEE2E2'
            });
        } else {
            productosSeleccionados.set(productoId, productoNombre);
            select.style.borderColor = 'var(--border)';
            select.style.boxShadow = '';
        }
    });
    return !hayDuplicados;
}

// Validar duplicados al seleccionar un producto
if (tableBody) {
    tableBody.addEventListener('change', function(e) {
        if (e.target.tagName === 'SELECT' && e.target.name.includes('producto')) {
            setTimeout(validarProductosDuplicados, 100);
        }
    });
}

// ============================================
// TOTALIZADOR DE PRODUCTOS
// ============================================

function actualizarTotalizador() {
    let totalProductos = 0;
    let totalCosto = 0;
    tableBody.querySelectorAll('.producto-row').forEach((row) => {
        if (row.style.display === 'none') return;
        const deleteField = row.querySelector('input[name$="-DELETE"]');
        if (deleteField && deleteField.checked) return;
        const select = row.querySelector('select[name$="-producto"]');
        const costoInput = row.querySelector('input[name$="-costo"]');
        if (select && select.value && costoInput && costoInput.value) {
            totalProductos++;
            totalCosto += parseFloat(costoInput.value) || 0;
        }
    });
    if (agregarBtn && totalProductos > 0) {
        const textoOriginal = '‚ûï Agregar producto';
        agregarBtn.innerHTML = `${textoOriginal} <span style="background: #4CAF50; color: white; padding: 0.2rem 0.5rem; border-radius: 999px; font-size: 0.85em; margin-left: 0.5rem;">${totalProductos}</span>`;
    }
}

// Actualizar totalizador cuando cambian los campos
if (tableBody) {
    tableBody.addEventListener('input', actualizarTotalizador);
    tableBody.addEventListener('change', actualizarTotalizador);
}

// Actualizar al cargar la p√°gina
document.addEventListener('DOMContentLoaded', actualizarTotalizador);

// ============================================
// AUTO-GUARDADO (SIMULADO - LOCAL STORAGE)
// ============================================

function guardarBorrador() {
    const datosFormulario = {
        es_proveedor_preferente: esPreferenteCheck ? esPreferenteCheck.checked : false,
        lead_time: leadTimeGeneralInput ? leadTimeGeneralInput.value : '',
        pedido_minimo: pedidoMinimoInput ? pedidoMinimoInput.value : '',
        observaciones: observacionesInput ? observacionesInput.value : '',
        estado: estadoSelect ? estadoSelect.value : '',
        timestamp: new Date().toISOString()
    };
    console.log('Borrador guardado:', datosFormulario);
    // Aqu√≠ podr√≠as guardar en localStorage si lo necesitas
}

// Guardar borrador cada 30 segundos
let intervaloGuardado = setInterval(guardarBorrador, 30000);

// Limpiar intervalo al enviar el formulario
form.addEventListener('submit', function() {
    clearInterval(intervaloGuardado);
});

// ============================================
// MEJORAS DE ACCESIBILIDAD
// ============================================

document.querySelectorAll('input, select, textarea').forEach(campo => {
    if (campo.hasAttribute('placeholder')) {
        campo.setAttribute('title', campo.getAttribute('placeholder'));
    }
});

// Enfocar primer campo con error
function enfocarPrimerError() {
    const primerError = document.querySelector('.form-control.error, input[style*="border-color: rgb(220, 38, 38)"]');
    if (primerError) {
        primerError.focus();
        primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// ============================================
// CONTADOR DE CARACTERES PARA OBSERVACIONES
// ============================================

if (observacionesInput) {
    const maxCaracteres = 1000;
    const contador = document.createElement('div');
    contador.style.cssText = 'text-align: right; font-size: 0.85rem; color: #6B7280; margin-top: 0.25rem;';
    observacionesInput.parentNode.appendChild(contador);
    function actualizarContador() {
        const longitud = observacionesInput.value.length;
        const restantes = maxCaracteres - longitud;
        contador.textContent = `${longitud}/${maxCaracteres} caracteres`;
        if (restantes < 100) {
            contador.style.color = '#F59E0B';
        } else if (restantes < 0) {
            contador.style.color = '#DC2626';
            Toast.fire({
                icon: 'warning',
                title: '‚ö†Ô∏è L√≠mite de caracteres',
                text: 'Has excedido el l√≠mite recomendado',
                background: '#FEE2E2'
            });
        } else {
            contador.style.color = '#6B7280';
        }
    }
    observacionesInput.addEventListener('input', actualizarContador);
    actualizarContador();
}

// ============================================
// RESUMEN FINAL AL CARGAR (SI HAY DATOS PREVIOS)
// ============================================

document.addEventListener('DOMContentLoaded', function() {
    const productosExistentes = Array.from(tableBody.querySelectorAll('.producto-row')).filter(row => {
        const select = row.querySelector('select[name$="-producto"]');
        return select && select.value;
    }).length;
    if (productosExistentes > 0) {
        Toast.fire({
            icon: 'info',
            title: `üì¶ ${productosExistentes} producto${productosExistentes !== 1 ? 's' : ''} configurado${productosExistentes !== 1 ? 's' : ''}`,
            background: '#DBEAFE'
        });
    }
});

console.log('‚úÖ Validaciones de Proveedor Paso 3 cargadas correctamente');
</script>
{% endblock %}