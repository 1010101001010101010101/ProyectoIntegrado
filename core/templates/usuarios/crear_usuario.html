{% extends 'base.html' %}

{% block title %}Crear Usuario - Dulcer√≠a Lilis{% endblock %}

{% block extra_css %}
<style>
  :root{
    --primary:#dc2626;--primary-700:#b91c1c;--ok:#16a34a;--warn:#f59e0b;--danger:#dc2626;
    --text:#111827;--muted:#6b7280;--border:#e5e7eb;--bg:#f9fafb;--shadow:0 6px 20px rgba(0,0,0,.08)
  }
  .page-header{display:flex;justify-content:space-between;align-items:center;margin:0 0 1.5rem}
  .page-title{font-size:1.6rem;font-weight:800;color:var(--text);display:flex;align-items:center;gap:.5rem}
  .btn{display:inline-flex;align-items:center;gap:.6rem;border:none;border-radius:12px;padding:.9rem 1.3rem;font-weight:800;cursor:pointer;transition:transform .15s ease, box-shadow .2s}
  .btn svg{width:18px;height:18px}
  .btn-secondary{background:#fff;border:2px solid var(--border);color:var(--text)}
  .btn-secondary:hover{background:var(--bg)}
  .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-700));color:#fff;box-shadow:0 10px 24px rgba(220,38,38,.25)}
  .btn-primary:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(220,38,38,.33)}
  .btn-primary:active{transform:translateY(0);box-shadow:0 8px 20px rgba(220,38,38,.25)}
  .form-card{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:2rem}
  .info-box{background:linear-gradient(135deg,#fef3c7,#fde68a);border-left:4px solid var(--warn);padding:1rem 1.2rem;border-radius:10px;margin-bottom:1rem}
  .form-section{margin-top:1.25rem;padding-top:1.25rem;border-top:2px solid var(--border)}
  .section-title{font-size:1.05rem;font-weight:800;color:var(--text);display:flex;align-items:center;gap:.6rem;margin:0 0 1rem}
  .section-title::before{content:'';width:4px;height:22px;background:linear-gradient(135deg,var(--primary),var(--primary-700));border-radius:2px}
  .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem}
  .form-group{display:flex;flex-direction:column}
  .form-group label{font-weight:700;color:var(--text);margin-bottom:.4rem;display:flex;align-items:center;gap:.35rem}
  .req-star{color:var(--danger)}
  .opt{color:var(--muted);font-weight:500}
  .form-control{border:2px solid var(--border);border-radius:10px;padding:.8rem 1rem;font-size:.95rem;transition:border .2s,box-shadow .2s}
  .form-control:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(220,38,38,.12)}
  .form-control.is-invalid{border-color:var(--danger);background:#fef2f2}
  .help-text{font-size:.8rem;color:var(--muted);margin-top:.35rem}

  /* Switch MFA */
  .switch{position:relative;display:inline-block;width:48px;height:26px}
  .switch input{opacity:0;width:0;height:0}
  .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#e5e7eb;border:2px solid #e5e7eb;transition:.2s;border-radius:999px}
  .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:white;transition:.2s;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.15)}
  .switch input:checked + .slider{background:linear-gradient(135deg,#16a34a,#22c55e);border-color:#16a34a}
  .switch input:checked + .slider:before{transform:translateX(22px)}

  /* Password UI */
  .password-strength{margin-top:.5rem;height:10px;background:#f3f4f6;border-radius:6px;overflow:hidden}
  .password-strength-bar{height:100%;width:0%;border-radius:6px;transition:width .35s ease, background .2s}
  .strength-weak{background:linear-gradient(90deg,#ef4444,#dc2626);width:33%}
  .strength-medium{background:linear-gradient(90deg,#f59e0b,#fbbf24);width:66%}
  .strength-strong{background:linear-gradient(90deg,#16a34a,#22c55e);width:100%}
  .password-requirements{display:none;margin-top:.6rem;background:var(--bg);border:1px dashed var(--border);padding:.75rem;border-radius:8px}
  .password-requirements.show{display:block}
  .requirement{display:flex;align-items:center;gap:.5rem;font-size:.9rem;margin:.25rem 0}
  .requirement.met{color:var(--ok)}
  .requirement.unmet{color:#9ca3af}
  .requirement span{font-weight:900}

  .errorlist{display:none}
  @media(max-width:768px){.page-header{flex-direction:column;align-items:flex-start;gap:1rem}.form-card{padding:1.25rem}}

  /* ...existing code... */
  .form-group select {
      width: 100%;
      padding: 0.8rem 1rem;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 0.95rem;
      background-color: #fff;
      transition: border .2s, box-shadow .2s;
  }
  .form-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(220,38,38,.12);
  }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">‚ûï Crear Nuevo Usuario</h1>
  <a href="{% url 'core:lista_usuarios' %}" class="btn btn-secondary">‚Üê Volver</a>
</div>

<div class="form-card">
  <div class="info-box">Complete los campos marcados con <span class="req-star">*</span>. Todas las validaciones se muestran con alertas.</div>

  <form id="create-user-form" method="post" novalidate>
    {% csrf_token %}

    <!-- Identificaci√≥n -->
    <div class="form-section">
      <h2 class="section-title">üë§ Identificaci√≥n</h2>

      <div class="form-row">
        <div class="form-group">
          <label for="{{ form.username.id_for_label }}">username <span class="req-star">*</span> <small class="help-text">√∫nico, sin espacios</small></label>
          {{ form.username }}
        </div>
        <div class="form-group">
          <label for="{{ form.email.id_for_label }}">email <span class="req-star">*</span></label>
          {{ form.email }}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="{{ form.first_name.id_for_label }}">nombres <span class="req-star">*</span></label>
          {{ form.first_name }}
        </div>
        <div class="form-group">
          <label for="{{ form.last_name.id_for_label }}">apellidos <span class="req-star">*</span></label>
          {{ form.last_name }}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="{{ form.telefono.id_for_label }}">tel√©fono <span class="opt">(opcional)</span></label>
          {{ form.telefono }}
        </div>
        <div class="form-group">
          <label for="{{ form.direccion.id_for_label }}">direcci√≥n <span class="opt">(opcional)</span></label>
          {{ form.direccion }}
        </div>
      </div>
    </div>

    <!-- Acceso -->
    <div class="form-section">
      <h2 class="section-title">üîê Acceso y seguridad</h2>

      <div class="form-row">
        <div class="form-group">
          <label for="{{ form.rol.id_for_label }}">rol <span class="req-star">*</span></label>
          {{ form.rol }}
        </div>
        <div class="form-group">
          <label for="{{ form.estado.id_for_label }}">estado <span class="req-star">*</span></label>
          {{ form.estado }} <!-- ‚Üê usar el campo del form, no un <select> manual -->
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="{{ form.password.id_for_label }}">contrase√±a <span class="req-star">*</span></label>
          
          {{ form.password }}
          <div class="password-strength"><div class="password-strength-bar" id="strength-bar"></div></div>
          <div class="password-requirements" id="password-requirements">
            <div class="requirement unmet" id="req-length"><span>‚óã</span> 8+ caracteres</div>
            <div class="requirement unmet" id="req-upper"><span>‚óã</span> 1 may√∫scula</div>
            <div class="requirement unmet" id="req-lower"><span>‚óã</span> 1 min√∫scula</div>
            <div class="requirement unmet" id="req-number"><span>‚óã</span> 1 n√∫mero</div>
            <div class="requirement unmet" id="req-special"><span>‚óã</span> 1 car√°cter especial</div>
          </div>
        </div>
        <div class="form-group">
          <label for="{{ form.password_confirm.id_for_label }}">confirmar contrase√±a <span class="req-star">*</span></label>
          {{ form.password_confirm }}
          <div class="help-text" id="password-match"></div>
        </div>
      </div>

      <!-- Extras solicitados -->
      <div class="form-row">
        <div class="form-group">
          <label>MFA habilitado <span class="req-star">*</span> <small class="help-text">(requerido; default 0)</small></label>
          <label class="switch">
            <input type="checkbox" id="mfa_enabled" name="mfa_enabled" value="1">
            <span class="slider"></span>
          </label>
          <small class="help-text">0 (deshabilitado)</small>
        </div>

        <div class="form-group">
          <label>√∫ltimo acceso <span class="opt">(solo lectura)</span></label>
          <input type="text" class="form-control" id="last_login" name="last_login" value="‚Äî" readonly>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>sesiones activas <span class="opt">(solo lectura)</span></label>
          <input type="text" class="form-control" id="active_sessions" name="active_sessions" value="0" readonly>
        </div>
      </div>
    </div>

    <div class="form-section" style="border-top:none;padding-top:0;margin-top:.5rem">
      <div style="display:flex;justify-content:space-between;gap:1rem">
        <a href="{% url 'core:lista_usuarios' %}" class="btn btn-secondary">‚úï Cancelar</a>
        <button type="submit" class="btn btn-primary">
          <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M16.707 5.293a1 1 0 0 1 0 1.414l-7.778 7.778a1 1 0 0 1-1.414 0L3.293 11.264a1 1 0 1 1 1.414-1.414l3.1 3.101 7.07-7.07a1 1 0 0 1 1.414 0z"/></svg>
          Crear Usuario
        </button>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const byId = id => document.getElementById(id);

  // Inputs
  const username = byId('{{ form.username.id_for_label }}');
  const email = byId('{{ form.email.id_for_label }}');
  const firstName = byId('{{ form.first_name.id_for_label }}');
  const lastName = byId('{{ form.last_name.id_for_label }}');
  const rol = byId('{{ form.rol.id_for_label }}');
  const estado = byId('{{ form.estado.id_for_label }}');
  const pwd = byId('{{ form.password.id_for_label }}');
  const pwd2 = byId('{{ form.password_confirm.id_for_label }}');

  // Username: min√∫sculas y sin espacios
  if (username) {
    username.addEventListener('input', e => {
      e.target.value = e.target.value.toLowerCase().replace(/\s+/g, '');
    });
  }

  // Password strength + colores
  const strengthBar = byId('strength-bar');
  const requirements = byId('password-requirements');
  const matchText = byId('password-match');

  function updateReq(id, ok){
    const el = byId(id);
    if (!el) return;
    el.classList.toggle('met', ok);
    el.classList.toggle('unmet', !ok);
    const span = el.querySelector('span');
    if (span){ span.textContent = ok ? '‚úì' : '‚óã'; }
  }

  function checkMatch(){
    if (!pwd || !pwd2) return;
    const same = pwd.value === pwd2.value && pwd2.value.length > 0;
    matchText.textContent = same ? 'Las contrase√±as coinciden' : (pwd2.value ? 'Las contrase√±as no coinciden' : '');
    matchText.style.color = same ? '#16a34a' : '#dc2626';
  }

  if (pwd){
    pwd.addEventListener('focus', ()=> requirements.classList.add('show'));
    pwd.addEventListener('input', ()=>{
      const v = pwd.value;
      const len = v.length >= 8;
      const up = /[A-Z]/.test(v);
      const lo = /[a-z]/.test(v);
      const num = /[0-9]/.test(v);
      const spe = /[^A-Za-z0-9]/.test(v);

      updateReq('req-length', len);
      updateReq('req-upper', up);
      updateReq('req-lower', lo);
      updateReq('req-number', num);
      updateReq('req-special', spe);

      const score = [len, up, lo, num, spe].filter(Boolean).length;
      strengthBar.className = 'password-strength-bar ' + (score<=2 ? 'strength-weak' : score<=3 ? 'strength-medium' : 'strength-strong');
      checkMatch();
    });
  }
  if (pwd2){ pwd2.addEventListener('input', checkMatch); }

  // Validaci√≥n cliente with SweetAlert
  function markInvalid(inputs){
    document.querySelectorAll('.form-control').forEach(i=> i.classList.remove('is-invalid'));
    inputs.forEach(i=> i && i.classList.add('is-invalid'));
  }

  function validarFormulario(){
    const errores = [];
    const invalids = [];

    if (!username.value.trim()) { errores.push('El username es obligatorio.'); invalids.push(username); }
    if (/\s/.test(username.value)) { errores.push('El username no puede tener espacios.'); invalids.push(username); }

    const emailVal = email.value.trim();
    if (!emailVal) { errores.push('El email es obligatorio.'); invalids.push(email); }
    else {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!re.test(emailVal)) { errores.push('El formato de email no es v√°lido.'); invalids.push(email); }
    }

    if (!firstName.value.trim()) { errores.push('Los nombres son obligatorios.'); invalids.push(firstName); }
    if (!lastName.value.trim()) { errores.push('Los apellidos son obligatorios.'); invalids.push(lastName); }

    if (!rol.value) { errores.push('Debe seleccionar un rol.'); invalids.push(rol); }
    if (!estado.value) { errores.push('Debe seleccionar el estado.'); invalids.push(estado); }

    const v = pwd.value || '';
    const okLen = v.length >= 8, okUp = /[A-Z]/.test(v), okLo = /[a-z]/.test(v), okNum = /[0-9]/.test(v), okSpe = /[^A-Za-z0-9]/.test(v);
    if (!okLen || !okUp || !okLo || !okNum || !okSpe) {
      errores.push('La contrase√±a debe tener 8+ caracteres, 1 may√∫scula, 1 min√∫scula, 1 n√∫mero y 1 car√°cter especial.');
      invalids.push(pwd);
    }
    if (pwd.value !== pwd2.value) {
      errores.push('Las contrase√±as no coinciden.');
      invalids.push(pwd2);
    }

    return { errores, invalids };
  }

  document.getElementById('create-user-form').addEventListener('submit', function(e){
    const { errores, invalids } = validarFormulario();
    if (errores.length){
      e.preventDefault();
      markInvalid(invalids);
      Swal.fire({
        icon:'error',
        title:'Revisa el formulario',
        html:'<ul style="text-align:left;margin:0;padding-left:1.1rem;">' + errores.map(x=>`<li>${x}</li>`).join('') + '</ul>',
        confirmButtonText:'Entendido',
        confirmButtonColor:'#dc2626'
      });
    }
  });

  // Errores del servidor ‚Üí SweetAlert
  {% if form.errors %}
    try{
      const serverErrors = JSON.parse('{{ form.errors.as_json|escapejs }}');
      const items = [];
      for (const k in serverErrors){
        const first = serverErrors[k][0]?.message || '';
        if (first){ items.push(first); }
      }
      if (items.length){
        Swal.fire({
          icon:'error',
          title:'No se pudo crear el usuario',
          html:'<ul style="text-align:left;margin:0;padding-left:1.1rem;">' + items.map(x=>`<li>${x}</li>`).join('') + '</ul>',
          confirmButtonText:'OK',
          confirmButtonColor:'#dc2626'
        });
      }
    }catch(_e){}
  {% endif %}
</script>
{% endblock %}