{% extends 'base.html' %}

{% block title %}Crear Usuario - Dulcer√≠a Lilis{% endblock %}

{% block extra_css %}
<style>
  :root{
    --primary:#dc2626;--primary-700:#b91c1c;--ok:#16a34a;--warn:#f59e0b;--danger:#dc2626;
    --text:#111827;--muted:#6b7280;--border:#e5e7eb;--bg:#f9fafb;--shadow:0 6px 20px rgba(0,0,0,.08)
  }
  .page-header{display:flex;justify-content:space-between;align-items:center;margin:0 0 1.5rem}
  .page-title{font-size:1.6rem;font-weight:800;color:var(--text);display:flex;align-items:center;gap:.5rem}
  .btn{display:inline-flex;align-items:center;gap:.6rem;border:none;border-radius:12px;padding:.9rem 1.3rem;font-weight:800;cursor:pointer;transition:transform .15s ease, box-shadow .2s}
  .btn svg{width:18px;height:18px}
  .btn-secondary{background:#fff;border:2px solid var(--border);color:var(--text)}
  .btn-secondary:hover{background:var(--bg)}
  .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-700));color:#fff;box-shadow:0 10px 24px rgba(220,38,38,.25)}
  .btn-primary:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(220,38,38,.33)}
  .btn-primary:active{transform:translateY(0);box-shadow:0 8px 20px rgba(220,38,38,.25)}
  .form-card{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:2rem}
  .info-box{background:linear-gradient(135deg,#fef3c7,#fde68a);border-left:4px solid var(--warn);padding:1rem 1.2rem;border-radius:10px;margin-bottom:1rem}
  .form-section{margin-top:1.25rem;padding-top:1.25rem;border-top:2px solid var(--border)}
  .section-title{font-size:1.05rem;font-weight:800;color:var(--text);display:flex;align-items:center;gap:.6rem;margin:0 0 1rem}
  .section-title::before{content:'';width:4px;height:22px;background:linear-gradient(135deg,var(--primary),var(--primary-700));border-radius:2px}
  .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem}
  .form-group{display:flex;flex-direction:column}
  .form-group label{font-weight:700;color:var(--text);margin-bottom:.4rem;display:flex;align-items:center;gap:.35rem}
  .req-star{color:var(--danger)}
  .opt{color:var(--muted);font-weight:500}
  .form-control{border:2px solid var(--border);border-radius:10px;padding:.8rem 1rem;font-size:.95rem;transition:border .2s,box-shadow .2s}
  .form-control:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(220,38,38,.12)}
  .form-control.is-invalid{border-color:var(--danger);background:#fef2f2}
  .help-text{font-size:.8rem;color:var(--muted);margin-top:.35rem}

  /* Switch MFA */
  .switch{position:relative;display:inline-block;width:48px;height:26px}
  .switch input{opacity:0;width:0;height:0}
  .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#e5e7eb;border:2px solid #e5e7eb;transition:.2s;border-radius:999px}
  .slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:white;transition:.2s;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.15)}
  .switch input:checked + .slider{background:linear-gradient(135deg,#16a34a,#22c55e);border-color:#16a34a}
  .switch input:checked + .slider:before{transform:translateX(22px)}

  /* Password UI */
  .password-strength{margin-top:.5rem;height:10px;background:#f3f4f6;border-radius:6px;overflow:hidden}
  .password-strength-bar{height:100%;width:0%;border-radius:6px;transition:width .35s ease, background .2s}
  .strength-weak{background:linear-gradient(90deg,#ef4444,#dc2626);width:33%}
  .strength-medium{background:linear-gradient(90deg,#f59e0b,#fbbf24);width:66%}
  .strength-strong{background:linear-gradient(90deg,#16a34a,#22c55e);width:100%}
  .password-requirements{display:none;margin-top:.6rem;background:var(--bg);border:1px dashed var(--border);padding:.75rem;border-radius:8px}
  .password-requirements.show{display:block}
  .requirement{display:flex;align-items:center;gap:.5rem;font-size:.9rem;margin:.25rem 0}
  .requirement.met{color:var(--ok)}
  .requirement.unmet{color:#9ca3af}
  .requirement span{font-weight:900}

  .errorlist{display:none}
  @media(max-width:768px){.page-header{flex-direction:column;align-items:flex-start;gap:1rem}.form-card{padding:1.25rem}}

  /* ...existing code... */
  .form-group select {
      width: 100%;
      padding: 0.8rem 1rem;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 0.95rem;
      background-color: #fff;
      transition: border .2s, box-shadow .2s;
  }
  .form-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(220,38,38,.12);
  }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <h1 class="page-title">‚ûï Crear Nuevo Usuario</h1>
  <a href="{% url 'core:lista_usuarios' %}" class="btn btn-secondary">‚Üê Volver</a>
</div>

<div class="form-card">
  <div class="info-box">Complete los campos marcados con <span class="req-star">*</span>. Todas las validaciones se muestran con alertas.</div>

  <form id="create-user-form" method="post" novalidate>
    {% csrf_token %}

    <!-- Identificaci√≥n -->
    <div class="form-section">
      <h2 class="section-title">üë§ Identificaci√≥n</h2>

      <div class="form-row">
        <div class="form-group">
          <label for="{{ form.username.id_for_label }}">username <span class="req-star">*</span> <small class="help-text">√∫nico, sin espacios</small></label>
          {{ form.username }}
        </div>
        <div class="form-group">
          <label for="{{ form.email.id_for_label }}">email <span class="req-star">*</span></label>
          {{ form.email }}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="{{ form.first_name.id_for_label }}">nombres <span class="req-star">*</span></label>
          {{ form.first_name }}
        </div>
        <div class="form-group">
          <label for="{{ form.last_name.id_for_label }}">apellidos <span class="req-star">*</span></label>
          {{ form.last_name }}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="{{ form.telefono.id_for_label }}">tel√©fono <span class="opt">(opcional)</span></label>
          {{ form.telefono }}
        </div>
        <div class="form-group">
          <label for="{{ form.direccion.id_for_label }}">direcci√≥n <span class="opt">(opcional)</span></label>
          {{ form.direccion }}
        </div>
      </div>
    </div>

    <!-- Acceso -->
    <div class="form-section">
      <h2 class="section-title">üîê Acceso y seguridad</h2>

      <div class="form-row">
        <div class="form-group">
          <label for="{{ form.rol.id_for_label }}">rol <span class="req-star">*</span></label>
          {{ form.rol }}
        </div>
        <div class="form-group">
          <label for="{{ form.estado.id_for_label }}">estado <span class="req-star">*</span></label>
          {{ form.estado }} <!-- ‚Üê usar el campo del form, no un <select> manual -->
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="{{ form.password.id_for_label }}">contrase√±a <span class="req-star">*</span></label>
          
          {{ form.password }}
          <div class="password-strength"><div class="password-strength-bar" id="strength-bar"></div></div>
          <div class="password-requirements" id="password-requirements">
            <div class="requirement unmet" id="req-length"><span>‚óã</span> 8+ caracteres</div>
            <div class="requirement unmet" id="req-upper"><span>‚óã</span> 1 may√∫scula</div>
            <div class="requirement unmet" id="req-lower"><span>‚óã</span> 1 min√∫scula</div>
            <div class="requirement unmet" id="req-number"><span>‚óã</span> 1 n√∫mero</div>
            <div class="requirement unmet" id="req-special"><span>‚óã</span> 1 car√°cter especial</div>
          </div>
        </div>
        <div class="form-group">
          <label for="{{ form.password_confirm.id_for_label }}">confirmar contrase√±a <span class="req-star">*</span></label>
          {{ form.password_confirm }}
          <div class="help-text" id="password-match"></div>
        </div>
      </div>

      <!-- Extras solicitados -->
      <div class="form-row">
        <div class="form-group">
          <label>MFA habilitado <span class="req-star">*</span> <small class="help-text">(requerido; default 0)</small></label>
          <label class="switch">
            <input type="checkbox" id="mfa_enabled" name="mfa_enabled" value="1">
            <span class="slider"></span>
          </label>
          <small class="help-text">0 (deshabilitado)</small>
        </div>

        <div class="form-group">
          <label>√∫ltimo acceso <span class="opt">(solo lectura)</span></label>
          <input type="text" class="form-control" id="last_login" name="last_login" value="‚Äî" readonly>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>sesiones activas <span class="opt">(solo lectura)</span></label>
          <input type="text" class="form-control" id="active_sessions" name="active_sessions" value="0" readonly>
        </div>
      </div>
    </div>

    <div class="form-section" style="border-top:none;padding-top:0;margin-top:.5rem">
      <div style="display:flex;justify-content:space-between;gap:1rem">
        <a href="{% url 'core:lista_usuarios' %}" class="btn btn-secondary">‚úï Cancelar</a>
        <button type="submit" class="btn btn-primary">
          <svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M16.707 5.293a1 1 0 0 1 0 1.414l-7.778 7.778a1 1 0 0 1-1.414 0L3.293 11.264a1 1 0 1 1 1.414-1.414l3.1 3.101 7.07-7.07a1 1 0 0 1 1.414 0z"/></svg>
          Crear Usuario
        </button>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// ============================================
// CREAR USUARIO - VALIDACIONES Y SWEETALERTS PRO
// ============================================

// Toast personalizado
const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true,
    didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer)
        toast.addEventListener('mouseleave', Swal.resumeTimer)
    }
});

// Mensaje de bienvenida
document.addEventListener('DOMContentLoaded', function() {
    Swal.fire({
        icon: 'info',
        title: 'üë§ Nuevo Usuario',
        html: '<p>Complete todos los campos requeridos</p><small style="color: #6B7280;">Validaci√≥n en tiempo real activada</small>',
        timer: 3000,
        showConfirmButton: false,
        toast: true,
        position: 'top-end',
        background: '#FEE2E2',
        iconColor: '#dc2626'
    });
});

const byId = id => document.getElementById(id);

// Inputs
const username = byId('{{ form.username.id_for_label }}');
const email = byId('{{ form.email.id_for_label }}');
const firstName = byId('{{ form.first_name.id_for_label }}');
const lastName = byId('{{ form.last_name.id_for_label }}');
const telefono = byId('{{ form.telefono.id_for_label }}');
const direccion = byId('{{ form.direccion.id_for_label }}');
const rol = byId('{{ form.rol.id_for_label }}');
const estado = byId('{{ form.estado.id_for_label }}');
const pwd = byId('{{ form.password.id_for_label }}');
const pwd2 = byId('{{ form.password_confirm.id_for_label }}');
const mfaEnabled = byId('mfa_enabled');

// Password strength + colores
const strengthBar = byId('strength-bar');
const requirements = byId('password-requirements');
const matchText = byId('password-match');

// VALIDACI√ìN DE USERNAME
if (username) {
    username.addEventListener('input', function(e) {
        let valor = e.target.value.toLowerCase().replace(/\s+/g, '');
        valor = valor.replace(/[^a-z0-9_]/g, '');
        e.target.value = valor;
        if (valor.length >= 3) {
            e.target.style.borderColor = '#10B981';
            e.target.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
        } else if (valor.length > 0) {
            e.target.style.borderColor = '#F59E0B';
            e.target.style.boxShadow = '0 0 0 3px rgba(245, 158, 11, 0.1)';
        } else {
            e.target.style.borderColor = 'var(--border)';
            e.target.style.boxShadow = '';
        }
    });
    username.addEventListener('blur', function(e) {
        const valor = e.target.value.trim();
        if (valor && valor.length < 3) {
            Swal.fire({
                icon: 'warning',
                title: '‚ö†Ô∏è Username muy corto',
                html: '<p>El username debe tener al menos <strong>3 caracteres</strong></p>',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#dc2626'
            });
            e.target.focus();
        } else if (valor && valor.length >= 3) {
            Toast.fire({
                icon: 'success',
                title: '‚úì Username v√°lido',
                background: '#D1FAE5'
            });
        }
    });
}

// VALIDACI√ìN DE EMAIL
function validarEmail(valor) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(valor);
}
if (email) {
    email.addEventListener('input', function(e) {
        const valor = e.target.value.trim();
        if (validarEmail(valor)) {
            e.target.style.borderColor = '#10B981';
            e.target.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
        } else if (valor.length > 0) {
            e.target.style.borderColor = '#F59E0B';
            e.target.style.boxShadow = '0 0 0 3px rgba(245, 158, 11, 0.1)';
        } else {
            e.target.style.borderColor = 'var(--border)';
            e.target.style.boxShadow = '';
        }
    });
    email.addEventListener('blur', function(e) {
        const valor = e.target.value.trim();
        if (valor && !validarEmail(valor)) {
            Swal.fire({
                icon: 'error',
                title: '‚ùå Email inv√°lido',
                html: `
                    <div style="text-align: center; margin: 1rem 0;">
                        <p>El formato del email no es v√°lido</p>
                        <div style="background: #F3F4F6; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <strong style="color: #1F2937;">Ejemplo v√°lido:</strong>
                            <div style="color: #10B981; font-size: 1.2rem; font-weight: bold; margin-top: 0.5rem;">
                                usuario@empresa.com
                            </div>
                        </div>
                    </div>
                `,
                confirmButtonText: 'Corregir',
                confirmButtonColor: '#dc2626'
            });
            e.target.focus();
        } else if (valor && validarEmail(valor)) {
            Toast.fire({
                icon: 'success',
                title: '‚úì Email v√°lido',
                background: '#D1FAE5'
            });
        }
    });
}

// VALIDACI√ìN DE NOMBRES Y APELLIDOS
function validarNombre(campo, etiqueta) {
    if (!campo) return;
    campo.addEventListener('input', function(e) {
        const valor = e.target.value.trim();
        if (valor.length >= 2) {
            e.target.style.borderColor = '#10B981';
            e.target.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
        } else if (valor.length > 0) {
            e.target.style.borderColor = '#F59E0B';
        } else {
            e.target.style.borderColor = 'var(--border)';
            e.target.style.boxShadow = '';
        }
    });
    campo.addEventListener('blur', function(e) {
        const valor = e.target.value.trim();
        if (valor && valor.length < 2) {
            Toast.fire({
                icon: 'warning',
                title: `‚ö†Ô∏è ${etiqueta} muy corto`,
                text: 'Debe tener al menos 2 caracteres',
                background: '#FEF3C7'
            });
        }
    });
}
validarNombre(firstName, 'Nombres');
validarNombre(lastName, 'Apellidos');

// VALIDACI√ìN DE TEL√âFONO
function validarTelefono(valor) {
    if (!valor) return true;
    const telRegex = /^(\+?56)?(\s?)(0?9)(\s?)\d{4}(\s?)\d{4}$/;
    return telRegex.test(valor);
}
if (telefono) {
    telefono.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^\d\s+()-]/g, '');
        const valor = e.target.value.trim();
        if (valor && validarTelefono(valor)) {
            e.target.style.borderColor = '#10B981';
            e.target.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
        } else if (valor.length > 0) {
            e.target.style.borderColor = '#F59E0B';
        } else {
            e.target.style.borderColor = 'var(--border)';
            e.target.style.boxShadow = '';
        }
    });
    telefono.addEventListener('blur', function(e) {
        const valor = e.target.value.trim();
        if (valor && !validarTelefono(valor)) {
            Toast.fire({
                icon: 'info',
                title: 'üì± Formato de tel√©fono',
                text: 'Formato sugerido: +56 9 1234 5678',
                background: '#DBEAFE'
            });
        }
    });
}

// VALIDACI√ìN DE CONTRASE√ëA
function updateReq(id, ok){
    const el = byId(id);
    if (!el) return;
    el.classList.toggle('met', ok);
    el.classList.toggle('unmet', !ok);
    const span = el.querySelector('span');
    if (span){ span.textContent = ok ? '‚úì' : '‚óã'; }
}
function checkMatch(){
    if (!pwd || !pwd2) return;
    const same = pwd.value === pwd2.value && pwd2.value.length > 0;
    matchText.textContent = same ? '‚úì Las contrase√±as coinciden' : (pwd2.value ? '‚úï Las contrase√±as no coinciden' : '');
    matchText.style.color = same ? '#16a34a' : '#dc2626';
    matchText.style.fontWeight = '600';
    if (pwd2.value.length > 0) {
        if (same) {
            pwd2.style.borderColor = '#10B981';
            pwd2.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
        } else {
            pwd2.style.borderColor = '#DC2626';
            pwd2.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.1)';
        }
    }
}
if (pwd){
    pwd.addEventListener('focus', ()=> {
        requirements.classList.add('show');
        Toast.fire({
            icon: 'info',
            title: 'üîê Requisitos de contrase√±a',
            text: 'Debe cumplir todos los requisitos',
            background: '#DBEAFE'
        });
    });
    pwd.addEventListener('input', ()=>{
        const v = pwd.value;
        const len = v.length >= 8;
        const up = /[A-Z]/.test(v);
        const lo = /[a-z]/.test(v);
        const num = /[0-9]/.test(v);
        const spe = /[^A-Za-z0-9]/.test(v);
        updateReq('req-length', len);
        updateReq('req-upper', up);
        updateReq('req-lower', lo);
        updateReq('req-number', num);
        updateReq('req-special', spe);
        const score = [len, up, lo, num, spe].filter(Boolean).length;
        strengthBar.className = 'password-strength-bar ' + (score<=2 ? 'strength-weak' : score<=3 ? 'strength-medium' : 'strength-strong');
        if (score === 5) {
            pwd.style.borderColor = '#10B981';
            pwd.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
        } else if (score >= 3) {
            pwd.style.borderColor = '#F59E0B';
            pwd.style.boxShadow = '0 0 0 3px rgba(245, 158, 11, 0.1)';
        } else if (v.length > 0) {
            pwd.style.borderColor = '#DC2626';
            pwd.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.1)';
        } else {
            pwd.style.borderColor = 'var(--border)';
            pwd.style.boxShadow = '';
        }
        checkMatch();
    });
    pwd.addEventListener('blur', function() {
        const v = pwd.value;
        const allMet = v.length >= 8 && /[A-Z]/.test(v) && /[a-z]/.test(v) && /[0-9]/.test(v) && /[^A-Za-z0-9]/.test(v);
        if (v && allMet) {
            Toast.fire({
                icon: 'success',
                title: '‚úì Contrase√±a fuerte',
                background: '#D1FAE5'
            });
        }
    });
}
if (pwd2){ 
    pwd2.addEventListener('input', checkMatch);
    pwd2.addEventListener('blur', function() {
        if (pwd2.value && pwd.value === pwd2.value) {
            Toast.fire({
                icon: 'success',
                title: '‚úì Contrase√±as coinciden',
                background: '#D1FAE5'
            });
        }
    });
}

// VALIDACI√ìN DE ROL Y ESTADO
if (rol) {
    rol.addEventListener('change', function(e) {
        if (e.target.value) {
            const rolTexto = e.target.options[e.target.selectedIndex].text;
            Toast.fire({
                icon: 'success',
                title: `üëî Rol: ${rolTexto}`,
                background: '#D1FAE5'
            });
        }
    });
}
if (estado) {
    estado.addEventListener('change', function(e) {
        const estadoIconos = {
            'ACTIVO': { icon: '‚úÖ', color: '#10B981', bg: '#D1FAE5', texto: 'Usuario activo' },
            'INACTIVO': { icon: '‚è∏Ô∏è', color: '#6B7280', bg: '#F3F4F6', texto: 'Usuario inactivo' },
            'SUSPENDIDO': { icon: 'üö´', color: '#DC2626', bg: '#FEE2E2', texto: 'Usuario suspendido' }
        };
        const info = estadoIconos[e.target.value];
        if (info) {
            Toast.fire({
                icon: 'info',
                title: `${info.icon} ${info.texto}`,
                background: info.bg
            });
        }
    });
}

// MFA TOGGLE
if (mfaEnabled) {
    mfaEnabled.addEventListener('change', function(e) {
        if (e.target.checked) {
            Swal.fire({
                icon: 'info',
                title: 'üîê MFA Habilitado',
                html: '<p>El usuario deber√° configurar autenticaci√≥n de dos factores</p>',
                timer: 3000,
                showConfirmButton: false,
                toast: true,
                position: 'top-end',
                background: '#DBEAFE',
                iconColor: '#2563EB'
            });
        } else {
            Toast.fire({
                icon: 'warning',
                title: '‚ö†Ô∏è MFA deshabilitado',
                background: '#FEF3C7'
            });
        }
    });
}

// VALIDACI√ìN PRINCIPAL DEL FORMULARIO
function markInvalid(inputs){
    document.querySelectorAll('.form-control').forEach(i=> {
        i.classList.remove('is-invalid');
        i.style.borderColor = 'var(--border)';
        i.style.boxShadow = '';
    });
    inputs.forEach(i=> {
        if (i) {
            i.classList.add('is-invalid');
            i.style.borderColor = '#DC2626';
            i.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.1)';
        }
    });
}
function validarFormulario(){
    const errores = [];
    const invalids = [];
    const usernameVal = username.value.trim();
    if (!usernameVal) { 
        errores.push('üë§ El username es obligatorio'); 
        invalids.push(username); 
    } else if (usernameVal.length < 3) {
        errores.push('üë§ El username debe tener al menos 3 caracteres');
        invalids.push(username);
    }
    if (/\s/.test(username.value)) { 
        errores.push('üë§ El username no puede contener espacios'); 
        invalids.push(username); 
    }
    const emailVal = email.value.trim();
    if (!emailVal) { 
        errores.push('üìß El email es obligatorio'); 
        invalids.push(email); 
    } else if (!validarEmail(emailVal)) { 
        errores.push('üìß El formato de email no es v√°lido'); 
        invalids.push(email); 
    }
    if (!firstName.value.trim()) { 
        errores.push('‚úçÔ∏è Los nombres son obligatorios'); 
        invalids.push(firstName); 
    } else if (firstName.value.trim().length < 2) {
        errores.push('‚úçÔ∏è Los nombres deben tener al menos 2 caracteres');
        invalids.push(firstName);
    }
    if (!lastName.value.trim()) { 
        errores.push('‚úçÔ∏è Los apellidos son obligatorios'); 
        invalids.push(lastName); 
    } else if (lastName.value.trim().length < 2) {
        errores.push('‚úçÔ∏è Los apellidos deben tener al menos 2 caracteres');
        invalids.push(lastName);
    }
    const telefonoVal = telefono ? telefono.value.trim() : '';
    if (telefonoVal && !validarTelefono(telefonoVal)) {
        errores.push('üì± El formato del tel√©fono no es v√°lido');
        invalids.push(telefono);
    }
    if (!rol.value) { 
        errores.push('üëî Debe seleccionar un rol'); 
        invalids.push(rol); 
    }
    if (!estado.value) { 
        errores.push('üìä Debe seleccionar el estado del usuario'); 
        invalids.push(estado); 
    }
    const v = pwd.value || '';
    const okLen = v.length >= 8;
    const okUp = /[A-Z]/.test(v);
    const okLo = /[a-z]/.test(v);
    const okNum = /[0-9]/.test(v);
    const okSpe = /[^A-Za-z0-9]/.test(v);
    if (!okLen || !okUp || !okLo || !okNum || !okSpe) {
        errores.push('üîê La contrase√±a no cumple todos los requisitos de seguridad');
        invalids.push(pwd);
    }
    if (pwd.value !== pwd2.value) {
        errores.push('üîê Las contrase√±as no coinciden');
        invalids.push(pwd2);
    }
    return { errores, invalids };
}
document.getElementById('create-user-form').addEventListener('submit', function(e){
    e.preventDefault();
    const { errores, invalids } = validarFormulario();
    if (errores.length){
        markInvalid(invalids);
        let listaErrores = '<ul style="text-align: left; margin: 1rem 0; padding-left: 1.5rem;">';
        errores.forEach(error => {
            listaErrores += `<li style="margin: 0.5rem 0;">${error}</li>`;
        });
        listaErrores += '</ul>';
        Swal.fire({
            icon: 'error',
            title: '‚ùå Errores en el formulario',
            html: `
                <p style="margin-bottom: 1rem;">Por favor corrija los siguientes errores:</p>
                ${listaErrores}
                <div style="background: #FEE2E2; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <strong style="color: #DC2626;">Total: ${errores.length} error${errores.length !== 1 ? 'es' : ''}</strong>
                </div>
            `,
            confirmButtonText: 'Entendido',
            confirmButtonColor: '#dc2626',
            width: '600px',
            willClose: () => {
                if (invalids[0]) {
                    invalids[0].focus();
                    invalids[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
        return;
    }
    mostrarConfirmacionFinal();
});

// CONFIRMACI√ìN FINAL
function mostrarConfirmacionFinal() {
    const usernameVal = username.value.trim();
    const emailVal = email.value.trim();
    const nombreCompleto = `${firstName.value.trim()} ${lastName.value.trim()}`;
    const rolTexto = rol.options[rol.selectedIndex].text;
    const estadoTexto = estado.options[estado.selectedIndex].text;
    const mfaTexto = mfaEnabled && mfaEnabled.checked ? 'Habilitado' : 'Deshabilitado';
    const estadoIconos = {
        'ACTIVO': { icon: '‚úÖ', color: '#10B981', bg: '#D1FAE5' },
        'INACTIVO': { icon: '‚è∏Ô∏è', color: '#6B7280', bg: '#F3F4F6' },
        'SUSPENDIDO': { icon: 'üö´', color: '#DC2626', bg: '#FEE2E2' }
    };
    const estadoInfo = estadoIconos[estado.value] || { icon: '‚ùì', color: '#6B7280', bg: '#F3F4F6' };
    let resumenHTML = `
        <div style="text-align: left; margin: 1.5rem 0; font-size: 0.95rem;">
            <div style="background: #F9FAFB; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <p style="margin: 0.5rem 0;"><strong>üë§ Username:</strong> ${usernameVal}</p>
                <p style="margin: 0.5rem 0;"><strong>‚úçÔ∏è Nombre completo:</strong> ${nombreCompleto}</p>
                <p style="margin: 0.5rem 0;"><strong>üìß Email:</strong> ${emailVal}</p>
            </div>
            <div style="display: grid; gap: 0.75rem;">
                <div style="background: #DBEAFE; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #2563EB;">
                    <strong style="color: #1F2937;">üëî Rol:</strong>
                    <span style="color: #2563EB; font-weight: bold;">${rolTexto}</span>
                </div>
                <div style="background: ${estadoInfo.bg}; padding: 0.75rem; border-radius: 6px; border-left: 3px solid ${estadoInfo.color};">
                    <strong style="color: #1F2937;">üìä Estado:</strong>
                    <span style="color: ${estadoInfo.color}; font-weight: bold;">${estadoInfo.icon} ${estadoTexto}</span>
                </div>
                <div style="background: ${mfaEnabled && mfaEnabled.checked ? '#D1FAE5' : '#FEF3C7'}; padding: 0.75rem; border-radius: 6px; border-left: 3px solid ${mfaEnabled && mfaEnabled.checked ? '#10B981' : '#F59E0B'};">
                    <strong style="color: #1F2937;">üîê MFA:</strong>
                    <span style="color: ${mfaEnabled && mfaEnabled.checked ? '#10B981' : '#F59E0B'}; font-weight: bold;">${mfaTexto}</span>
                </div>
            </div>
        </div>
    `;
    Swal.fire({
        icon: 'question',
        title: '¬øCrear usuario?',
        html: `
            <p style="color: #6B7280; margin-bottom: 1rem;">
                Se crear√° el usuario con la siguiente informaci√≥n
            </p>
            ${resumenHTML}
        `,
        showCancelButton: true,
        confirmButtonText: '‚úì S√≠, crear usuario',
        cancelButtonText: '‚Üê Revisar datos',
        confirmButtonColor: '#dc2626',
        cancelButtonColor: '#6B7280',
        width: '600px',
        backdrop: `rgba(220, 38, 38, 0.1)`
    }).then((result) => {
        if (result.isConfirmed) {
            crearUsuarioFinal();
        }
    });
}

// ANIMACI√ìN DE CREACI√ìN FINAL
function crearUsuarioFinal() {
    let etapa = 0;
    const etapas = [
        { icono: 'üìù', texto: 'Validando informaci√≥n...', progreso: 25 },
        { icono: 'üîê', texto: 'Encriptando contrase√±a...', progreso: 50 },
        { icono: 'üíæ', texto: 'Guardando en base de datos...', progreso: 75 },
        { icono: '‚úÖ', texto: 'Finalizando registro...', progreso: 100 }
    ];
    Swal.fire({
        title: etapas[0].texto,
        html: `
            <div style="margin: 1.5rem 0;">
                <div style="font-size: 3rem; margin-bottom: 1rem; animation: bounce 0.5s;">
                    ${etapas[0].icono}
                </div>
                <div style="background: #F3F4F6; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div id="progressBar" style="background: linear-gradient(90deg, #dc2626, #b91c1c); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                </div>
                <p style="color: #6B7280; margin-top: 1rem; font-size: 0.9em;">Por favor espere...</p>
            </div>
        `,
        showConfirmButton: false,
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
            const intervalo = setInterval(() => {
                if (etapa < etapas.length) {
                    const etapaActual = etapas[etapa];
                    Swal.update({
                        title: etapaActual.texto,
                        html: `
                            <div style="margin: 1.5rem 0;">
                                <div style="font-size: 3rem; margin-bottom: 1rem; animation: bounce 0.5s;">
                                    ${etapaActual.icono}
                                </div>
                                <div style="background: #F3F4F6; height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, #dc2626, #b91c1c); height: 100%; width: ${etapaActual.progreso}%; transition: width 0.5s ease;"></div>
                                </div>
                                <p style="color: #6B7280; margin-top: 1rem; font-size: 0.9em;">${etapaActual.progreso}% completado</p>
                            </div>
                        `
                    });
                    etapa++;
                } else {
                    clearInterval(intervalo);
                    mostrarExito();
                }
            }, 600);
        }
    });
}
function mostrarExito() {
    Swal.fire({
        icon: 'success',
        title: 'üéâ ¬°Usuario creado exitosamente!',
        html: `
            <div style="margin: 1.5rem 0;">
                <div style="background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%); padding: 1.5rem; border-radius: 12px; border: 2px solid #10B981;">
                    <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚úÖ</div>
                    <p style="color: #065F46; font-size: 1.1rem; margin: 0;">El usuario ha sido creado correctamente</p>
                </div>
                <div style="margin-top: 1.5rem; padding: 1rem; background: #F9FAFB; border-radius: 8px;">
                    <p style="color: #6B7280; margin: 0; font-size: 0.9em;">
                        ‚úì Cuenta de usuario creada<br>
                        ‚úì Contrase√±a encriptada<br>
                        ‚úì Permisos asignados<br>
                        ‚úì Usuario listo para acceder al sistema
                    </p>
                </div>
            </div>
        `,
        confirmButtonText: 'üë• Ver lista de usuarios',
        confirmButtonColor: '#dc2626',
        backdrop: `rgba(220, 38, 38, 0.1)`,
        willClose: () => {
            // Solo submit, sin window.location.href
            document.getElementById('create-user-form').submit();
            // El backend har√° el redirect autom√°ticamente
        }
    });
}

// ERRORES DEL SERVIDOR
{% if form.errors %}
document.addEventListener('DOMContentLoaded', function() {
    try {
        const serverErrors = JSON.parse('{{ form.errors.as_json|escapejs }}');
        const items = [];
        for (const k in serverErrors) {
            const messages = serverErrors[k];
            messages.forEach(msg => {
                const text = msg.message || '';
                if (text) { items.push(text); }
            });
        }
        if (items.length) {
            let listaErrores = '<ul style="text-align: left; margin: 1rem 0; padding-left: 1.5rem;">';
            items.forEach(error => {
                listaErrores += `<li style="margin: 0.5rem 0; color: #DC2626;">${error}</li>`;
            });
            listaErrores += '</ul>';
            Swal.fire({
                icon: 'error',
                title: '‚ùå No se pudo crear el usuario',
                html: `
                    <p style="margin-bottom: 1rem;">Se encontraron los siguientes errores:</p>
                    ${listaErrores}
                    <div style="background: #FEE2E2; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                        <strong style="color: #DC2626;">Por favor corrija estos errores e intente nuevamente</strong>
                    </div>
                `,
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#dc2626',
                width: '600px'
            });
        }
    } catch(_e) {
        console.error('Error parsing server errors:', _e);
    }
});
{% endif %}

// PREVENIR P√âRDIDA DE DATOS
let formModificado = false;
document.getElementById('create-user-form').addEventListener('input', function() {
    formModificado = true;
});
window.addEventListener('beforeunload', function(e) {
    if (formModificado) {
        e.preventDefault();
        e.returnValue = '';
        return '';
    }
});
document.getElementById('create-user-form').addEventListener('submit', function() {
    formModificado = false;
});

// ATAJOS DE TECLADO
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        document.getElementById('create-user-form').dispatchEvent(new Event('submit'));
    }
});

// MEJORAS DE ACCESIBILIDAD
document.querySelectorAll('input, select, textarea').forEach(campo => {
    if (campo.hasAttribute('placeholder')) {
        campo.setAttribute('title', campo.getAttribute('placeholder'));
    }
});

// AUTO-COMPLETAR SUGERENCIAS
if (firstName && lastName && email) {
    let suggestedUsername = false;
    function sugerirUsername() {
        if (suggestedUsername || username.value.trim().length > 0) return;
        const nombre = firstName.value.trim().toLowerCase();
        const apellido = lastName.value.trim().toLowerCase();
        if (nombre && apellido) {
            const sugerencia = `${nombre.charAt(0)}${apellido}`.replace(/\s+/g, '');
            if (sugerencia.length >= 3) {
                Swal.fire({
                    icon: 'info',
                    title: 'üí° Sugerencia de username',
                    html: `
                        <div style="text-align: center; margin: 1rem 0;">
                            <p>Basado en el nombre ingresado, sugerimos:</p>
                            <div style="background: #DBEAFE; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <strong style="color: #2563EB; font-size: 1.3rem;">${sugerencia}</strong>
                            </div>
                            <p style="color: #6B7280; font-size: 0.9em;">Puedes aceptarlo o escribir uno diferente</p>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: '‚úì Usar esta sugerencia',
                    cancelButtonText: 'Escribir otro',
                    confirmButtonColor: '#dc2626',
                    cancelButtonColor: '#6B7280'
                }).then((result) => {
                    if (result.isConfirmed) {
                        username.value = sugerencia;
                        username.dispatchEvent(new Event('input'));
                        suggestedUsername = true;
                        Toast.fire({
                            icon: 'success',
                            title: '‚úì Username asignado',
                            background: '#D1FAE5'
                        });
                    }
                });
            }
        }
    }
    firstName.addEventListener('blur', sugerirUsername);
    lastName.addEventListener('blur', sugerirUsername);
}

// VALIDACI√ìN DE DIRECCI√ìN (OPCIONAL)
if (direccion) {
    direccion.addEventListener('input', function(e) {
        const valor = e.target.value.trim();
        if (valor.length >= 5) {
            e.target.style.borderColor = '#10B981';
            e.target.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
        } else if (valor.length > 0) {
            e.target.style.borderColor = '#F59E0B';
        } else {
            e.target.style.borderColor = 'var(--border)';
            e.target.style.boxShadow = '';
        }
    });
}

// INDICADOR DE CAMPOS COMPLETADOS
function actualizarProgreso() {
    const camposRequeridos = [username, email, firstName, lastName, rol, estado, pwd, pwd2];
    const completados = camposRequeridos.filter(campo => campo && campo.value.trim().length > 0).length;
    const porcentaje = Math.round((completados / camposRequeridos.length) * 100);
    if (porcentaje === 100) {
        console.log('‚úÖ Todos los campos requeridos completados');
    }
}
document.getElementById('create-user-form').addEventListener('input', actualizarProgreso);

console.log('‚úÖ Validaciones de Crear Usuario cargadas correctamente');
</script>
{% endblock %}