{% extends 'base.html' %}

{% block title %}Productos - Dulcer√≠a Lilis{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 2rem;
        color: var(--text-dark);
        font-weight: 700;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 0.8rem 1.5rem;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 15px rgba(243, 4, 4, 0.3);
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(207, 4, 4, 0.5);
    }

    .export-btn {
        background: #10B981;
        color: white;
        padding: 0.8rem 1.5rem;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all .2s ease;
    }
    .export-btn:hover { transform: translateY(-2px); }

    .filters-bar {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 12px var(--shadow);
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    .search-input {
        flex: 1;
        min-width: 250px;
        padding: 0.8rem 1rem;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
    }
    .search-input:focus { outline: none; border-color: var(--primary); }

    .filter-select {
        padding: 0.8rem 1rem;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        min-width: 180px;
    }

    .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 12px var(--shadow);
    }
    table { width: 100%; border-collapse: collapse; }
    thead {
        background: linear-gradient(135deg, #ff0000 0%, #ff0000b8 100%);
        color: white;
    }
    th {
        padding: 1.2rem 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.95rem;
    }
    td { padding: 1rem; border-bottom: 1px solid var(--border); }
    tbody tr { transition: background-color 0.2s ease; }
    tbody tr:hover {
        background: linear-gradient(135deg, rgba(255, 217, 0, 0.05) 0%, rgba(211, 39, 39, 0.05) 100%);
    }

    .badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
    }
    .badge-success { background: #D4EDDA; color: #155724; }
    .badge-danger  { background: #F8D7DA; color: #721C24; }
    .badge-warning { background: #FFF3CD; color: #856404; }

    .action-buttons { display: flex; gap: 0.5rem; }
    .btn-icon {
        padding: 0.5rem 0.8rem; border: none; border-radius: 6px;
        cursor: pointer; transition: all 0.2s ease; font-size: 1rem;
        text-decoration: none; display: inline-block;
    }
    .btn-edit  { background: #E3F2FD; color: #1976D2; }
    .btn-edit:hover  { background: #1976D2; color: white; transform: scale(1.1); }
    .btn-delete { background: #FFEBEE; color: #C62828; }
    .btn-delete:hover { background: #C62828; color: white; transform: scale(1.1); }

    /* Paginaci√≥n */
    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
    }
    .pagination a, .pagination span {
        padding: 0.6rem 1rem;
        border: 2px solid var(--border);
        border-radius: 6px;
        text-decoration: none;
        color: var(--text-dark);
        font-weight: 600;
        transition: all 0.2s ease;
    }
    .pagination a:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    .pagination .current {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    @media (max-width: 768px) {
        .page-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
        .table-container { overflow-x: auto; }
        table { min-width: 1000px; }
    }

    /* SweetAlert2 */
    .swal2-popup { border-radius: 16px; }
    .swal2-confirm {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%) !important;
        border-radius: 8px; padding: 0.6rem 2rem; font-weight: 600;
    }
    .swal2-cancel {
        background: #6c757d !important; border-radius: 8px; padding: 0.6rem 2rem; font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Gesti√≥n de Productos</h1>
    <div style="display: flex; gap: 1rem;">
        <a href="{% url 'core:exportar_productos_excel' %}" class="export-btn">üìä Exportar Excel</a>
        <a href="{% url 'core:producto_paso1' %}" class="btn-primary"><span>‚ûï</span> Nuevo Producto</a>
    </div>
</div>

<div class="filters-bar">
    <form method="get" style="display: contents;">
        <input
            type="text" name="q" class="search-input"
            placeholder="Buscar por SKU, nombre o categor√≠a..."
            value="{{ query }}"
        />

        <select name="categoria" class="filter-select" onchange="this.form.submit()">
            <option value="">Todas las categor√≠as</option>
            {% for cat in categorias %}
                <option value="{{ cat.nombre }}" {% if categoria_filtro == cat.nombre %}selected{% endif %}>
                    {{ cat.nombre }}
                </option>
            {% endfor %}
        </select>

        <select name="estado" class="filter-select" onchange="this.form.submit()">
            <option value="">Estado Stock</option>
            <option value="ok"   {% if estado_filtro == 'ok' %}selected{% endif %}>Stock √ìptimo</option>
            <option value="bajo" {% if estado_filtro == 'bajo' %}selected{% endif %}>Stock Bajo</option>
        </select>

        <select name="orden" class="filter-select" onchange="this.form.submit()">
            <option value="nombre"   {% if orden == 'nombre' %}selected{% endif %}>Nombre A-Z</option>
            <option value="-nombre"  {% if orden == '-nombre' %}selected{% endif %}>Nombre Z-A</option>
            <option value="sku"      {% if orden == 'sku' %}selected{% endif %}>SKU A-Z</option>
            <option value="-precio"  {% if orden == '-precio' %}selected{% endif %}>Precio Mayor</option>
            <option value="precio"   {% if orden == 'precio' %}selected{% endif %}>Precio Menor</option>
            <option value="-stock"   {% if orden == '-stock' %}selected{% endif %}>Stock Mayor</option>
        </select>

        <button type="submit" class="btn-primary">Buscar</button>
    </form>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>SKU</th>
                <th>Producto</th>
                <th>Categor√≠a</th>
                <th>Stock Actual</th>
                <th>Precio Venta</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
        {% for producto in productos %}
            <tr>
                <td><strong>{{ producto.sku }}</strong></td>
                <td>{{ producto.nombre }}</td>
                <td>{{ producto.categoria.nombre }}</td>
                <td>{{ producto.stock_actual }}</td>
                <td>${{ producto.precio_venta|floatformat:0 }}</td>
                <td>
                    {% if producto.alerta_bajo_stock %}
                        <span class="badge badge-warning">Stock Bajo</span>
                    {% else %}
                        <span class="badge badge-success">Stock OK</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons">
                        <a href="{% url 'core:editar_producto' producto.id %}" class="btn-icon btn-edit" title="Editar">‚úèÔ∏è</a>
                        <button class="btn-icon btn-delete" title="Eliminar"
                                onclick="confirmarEliminacion({{ producto.id }}, '{{ producto.nombre }}')">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="7" style="text-align: center; padding: 2rem;">
                    No se encontraron productos
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

{% if productos.has_other_pages %}
<div class="pagination">
    {% if productos.has_previous %}
        <a href="?page=1&q={{ query }}&categoria={{ categoria_filtro }}&estado={{ estado_filtro }}&orden={{ orden }}">¬´ Primera</a>
        <a href="?page={{ productos.previous_page_number }}&q={{ query }}&categoria={{ categoria_filtro }}&estado={{ estado_filtro }}&orden={{ orden }}">‚Äπ Anterior</a>
    {% endif %}

    <span class="current">P√°gina {{ productos.number }} de {{ productos.paginator.num_pages }}</span>

    {% if productos.has_next %}
        <a href="?page={{ productos.next_page_number }}&q={{ query }}&categoria={{ categoria_filtro }}&estado={{ estado_filtro }}&orden={{ orden }}">Siguiente ‚Ä∫</a>
        <a href="?page={{ productos.paginator.num_pages }}&q={{ query }}&categoria={{ categoria_filtro }}&estado={{ estado_filtro }}&orden={{ orden }}">√öltima ¬ª</a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function confirmarEliminacion(id, nombre) {
    Swal.fire({
        title: '¬øEst√°s seguro?',
        html: `¬øDeseas eliminar el producto <strong>${nombre}</strong>?<br><small style="color:#6c757d;">Esta acci√≥n no se puede deshacer</small>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar',
        reverseButtons: true,
        customClass: { confirmButton: 'swal2-confirm', cancelButton: 'swal2-cancel' }
    }).then((result) => {
        if (result.isConfirmed) {
            // TODO: Implementa eliminaci√≥n real, por ejemplo:
            // window.location.href = `{% url 'core:eliminar_producto' 0 %}`.replace('/0/', `/${id}/`);
            Swal.fire({
                title: '¬°Eliminado!',
                text: `El producto ${nombre} ha sido eliminado correctamente`,
                icon: 'success',
                confirmButtonText: 'Aceptar',
                customClass: { confirmButton: 'swal2-confirm' }
            });
        }
    });
}
</script>
{% endblock %}
