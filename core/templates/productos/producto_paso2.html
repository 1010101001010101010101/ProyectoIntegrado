{% extends 'base.html' %}

{% block title %}Nuevo Producto - Paso 2{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #2563eb;
        --primary-dark: #1e40af;
        --text-dark: #1f2937;
        --text-gray: #6b7280;
        --border: #e5e7eb;
        --shadow: rgba(0, 0, 0, 0.1);
    }
    
    .wizard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .wizard-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .wizard-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
    }
    
    /* WIZARD STEPS */
    .wizard-steps {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px var(--shadow);
    }
    
    .step {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        transition: all 0.3s ease;
        background: #f9fafb;
    }
    
    .step.completed {
        background: #22c55e;
        color: white;
    }
    
    .step.active {
        background: var(--primary);
        color: white;
    }
    
    .step-number {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
    }
    
    .step.completed .step-number {
        background: white;
        color: #22c55e;
    }
    
    .step.active .step-number {
        background: white;
        color: var(--primary);
    }
    
    /* FORM CARD */
    .form-card {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 12px var(--shadow);
    }
    
    .section-title {
        font-size: 1.1rem;
        color: var(--text-dark);
        font-weight: 700;
        margin: 1.5rem 0 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--border);
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        font-weight: 600;
        margin-bottom: 0.4rem;
        color: var(--text-dark);
        font-size: 0.9rem;
    }
    
    .label-hint {
        font-size: 0.75rem;
        color: var(--text-gray);
        margin-top: 0.25rem;
    }
    
    .form-control {
        padding: 0.75rem;
        border: 2px solid var(--border);
        border-radius: 6px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .form-control.error {
        border-color: #dc2626;
        background: #fef2f2;
    }
    
    /* CHECKBOXES */
    .checkbox-container {
        background: #f0f9ff;
        border: 2px solid #bfdbfe;
        border-radius: 8px;
        padding: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .checkbox-container:hover {
        background: #dbeafe;
        border-color: var(--primary);
    }
    
    .checkbox-container.checked {
        background: #dcfce7;
        border-color: #22c55e;
    }
    
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }
    
    .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: var(--primary);
    }
    
    .checkbox-label {
        font-size: 0.95rem;
        color: var(--text-dark);
        font-weight: 500;
        cursor: pointer;
        user-select: none;
    }
    
    /* FORM ACTIONS */
    .form-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 2px solid var(--border);
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
    }
    
    .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    
    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
    }
    
    .btn-secondary {
        background: #f3f4f6;
        color: var(--text-dark);
    }
    
    .btn-secondary:hover {
        background: #e5e7eb;
    }
    
    .error-message {
        color: #dc2626;
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
    <div class="wizard-header">
        <h1 class="wizard-title">Formulario de Producto</h1>
    </div>

    <!-- WIZARD STEPS -->
    <div class="wizard-steps">
        <div class="step completed">
            <div class="step-number">‚úì</div>
            <span>1. Identificaci√≥n y precios</span>
        </div>
        <div class="step active">
            <div class="step-number">2</div>
            <span>2. Stock y control</span>
        </div>
        <div class="step">
            <div class="step-number">3</div>
            <span>3. Relaciones y derivados</span>
        </div>
    </div>

    <!-- FORM CARD -->
    <div class="form-card">
        <form method="post" id="productoForm" novalidate>
            {% csrf_token %}
            
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {{ form.non_field_errors }}
                </div>
            {% endif %}

            <h2 class="section-title">Stock y control</h2>

            <!-- ROW 1: STOCK -->
            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.stock_minimo.id_for_label }}">
                        stock_minimo <span style="color: #dc2626;">*</span>
                    </label>
                    {{ form.stock_minimo }}
                    <span class="label-hint">{{ form.stock_minimo.help_text }}</span>
                    {% if form.stock_minimo.errors %}
                        <span class="error-message">{{ form.stock_minimo.errors }}</span>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.stock_maximo.id_for_label }}">stock_maximo</label>
                    {{ form.stock_maximo }}
                    <span class="label-hint">{{ form.stock_maximo.help_text }}</span>
                    {% if form.stock_maximo.errors %}
                        <span class="error-message">{{ form.stock_maximo.errors }}</span>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.punto_reorden.id_for_label }}">punto_reorden</label>
                    {{ form.punto_reorden }}
                    <span class="label-hint">{{ form.punto_reorden.help_text }}</span>
                    {% if form.punto_reorden.errors %}
                        <span class="error-message">{{ form.punto_reorden.errors }}</span>
                    {% endif %}
                </div>
            </div>

            <!-- ROW 2: STOCK ACTUAL -->
            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.stock_actual.id_for_label }}">
                        stock_actual <span style="color: #dc2626;">*</span>
                    </label>
                    {{ form.stock_actual }}
                    <span class="label-hint">{{ form.stock_actual.help_text }}</span>
                    {% if form.stock_actual.errors %}
                        <span class="error-message">{{ form.stock_actual.errors }}</span>
                    {% endif %}
                </div>
            </div>

            <!-- ROW 3: CHECKBOXES -->
            <div class="form-row">
                <div class="form-group">
                    <label>perishable</label>
                    <div class="checkbox-container" id="perishable-container" onclick="toggleCheckbox('{{ form.es_perecedero.id_for_label }}')">
                        <div class="checkbox-group">
                            {{ form.es_perecedero }}
                            <span class="checkbox-label" id="perishable-label">No perecedero</span>
                        </div>
                    </div>
                    <span class="label-hint">{{ form.es_perecedero.help_text }}</span>
                </div>

                <div class="form-group">
                    <label>control_por_lote</label>
                    <div class="checkbox-container" id="lote-container" onclick="toggleCheckbox('{{ form.requiere_lote.id_for_label }}')">
                        <div class="checkbox-group">
                            {{ form.requiere_lote }}
                            <span class="checkbox-label" id="lote-label">Sin control por lote</span>
                        </div>
                    </div>
                    <span class="label-hint">{{ form.requiere_lote.help_text }}</span>
                </div>

                <div class="form-group">
                    <label>control_por_serie</label>
                    <div class="checkbox-container" id="serie-container" onclick="toggleCheckbox('{{ form.requiere_serie.id_for_label }}')">
                        <div class="checkbox-group">
                            {{ form.requiere_serie }}
                            <span class="checkbox-label" id="serie-label">Sin control por serie</span>
                        </div>
                    </div>
                    <span class="label-hint">{{ form.requiere_serie.help_text }}</span>
                </div>
            </div>

            <!-- FORM ACTIONS -->
            <div class="form-actions">
                <a href="{% url 'core:producto_paso1' %}" class="btn btn-secondary">
                    ‚Üê Volver
                </a>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">
                        Limpiar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Guardar y Continuar ‚Üí
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// ============================================
// PRODUCTO PASO 2 - VALIDACIONES Y SWEETALERTS PRO
// ============================================

// Toast personalizado
const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true,
    didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer)
        toast.addEventListener('mouseleave', Swal.resumeTimer)
    }
});

// Mensaje de bienvenida
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar checkboxes
    updateCheckbox('{{ form.es_perecedero.id_for_label }}', 'perishable');
    updateCheckbox('{{ form.requiere_lote.id_for_label }}', 'lote');
    updateCheckbox('{{ form.requiere_serie.id_for_label }}', 'serie');
    // Toast de bienvenida
    Swal.fire({
        icon: 'success',
        title: 'üìä Control de Stock',
        html: '<p>Configure los niveles de inventario</p><small style="color: #6B7280;">Paso 2 de 3</small>',
        timer: 3000,
        showConfirmButton: false,
        toast: true,
        position: 'top-end',
        background: '#D1FAE5',
        iconColor: '#10B981'
    });
});

// ============================================
// FUNCIONES DE CHECKBOXES
// ============================================
function toggleCheckbox(id) {
    const checkbox = document.getElementById(id);
    checkbox.checked = !checkbox.checked;
    const prefix = id.includes('perecedero') ? 'perishable' : 
                   id.includes('lote') ? 'lote' : 'serie';
    updateCheckbox(id, prefix);
    event.stopPropagation();
}

function updateCheckbox(id, prefix) {
    const checkbox = document.getElementById(id);
    const container = document.getElementById(prefix + '-container');
    const label = document.getElementById(prefix + '-label');
    // Animaci√≥n
    container.style.transform = 'scale(0.95)';
    setTimeout(() => container.style.transform = 'scale(1)', 150);
    if (checkbox.checked) {
        container.classList.add('checked');
        container.style.boxShadow = '0 4px 12px rgba(34, 197, 94, 0.2)';
        if (prefix === 'perishable') {
            label.textContent = '‚úì Producto perecedero';
            Toast.fire({
                icon: 'warning',
                title: '‚ö†Ô∏è Producto perecedero activado',
                text: 'Se controlar√° fecha de vencimiento',
                background: '#FEF3C7'
            });
        }
        if (prefix === 'lote') {
            label.textContent = '‚úì Con control por lote';
            Toast.fire({
                icon: 'success',
                title: 'üì¶ Control por lote activado',
                background: '#D1FAE5'
            });
        }
        if (prefix === 'serie') {
            label.textContent = '‚úì Con control por serie';
            Toast.fire({
                icon: 'success',
                title: 'üî¢ Control por serie activado',
                background: '#D1FAE5'
            });
        }
    } else {
        container.classList.remove('checked');
        container.style.boxShadow = '';
        if (prefix === 'perishable') label.textContent = 'No perecedero';
        if (prefix === 'lote') label.textContent = 'Sin control por lote';
        if (prefix === 'serie') label.textContent = 'Sin control por serie';
    }
}

// ============================================
// VALIDACIONES DE STOCK EN TIEMPO REAL
// ============================================
const stockMinInput = document.getElementById('{{ form.stock_minimo.id_for_label }}');
const stockMaxInput = document.getElementById('{{ form.stock_maximo.id_for_label }}');
const puntoReordenInput = document.getElementById('{{ form.punto_reorden.id_for_label }}');
const stockActualInput = document.getElementById('{{ form.stock_actual.id_for_label }}');

function validarEntero(input) {
    input.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^\d]/g, '');
        if (e.target.value.length > 1) {
            e.target.value = e.target.value.replace(/^0+/, '');
        }
        e.target.classList.remove('error');
        const valor = parseInt(e.target.value) || 0;
        if (valor > 0) {
            e.target.style.borderColor = '#10B981';
            e.target.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
        } else {
            e.target.style.borderColor = 'var(--border)';
            e.target.style.boxShadow = '';
        }
    });
    input.addEventListener('blur', function(e) {
        validarRelacionesStock();
    });
}

validarEntero(stockMinInput);
validarEntero(stockMaxInput);
validarEntero(puntoReordenInput);
validarEntero(stockActualInput);

// Validar relaciones entre stocks
function validarRelacionesStock() {
    const stockMin = parseInt(stockMinInput.value) || 0;
    const stockMax = parseInt(stockMaxInput.value) || 0;
    const puntoReorden = parseInt(puntoReordenInput.value) || 0;
    const stockActual = parseInt(stockActualInput.value) || 0;

    // Validar Stock M√°ximo > Stock M√≠nimo
    if (stockMax > 0 && stockMin > 0 && stockMax < stockMin) {
        stockMaxInput.style.borderColor = '#DC2626';
        stockMaxInput.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.1)';
        Toast.fire({
            icon: 'error',
            title: '‚ùå Stock m√°ximo menor al m√≠nimo',
            text: 'El stock m√°ximo debe ser mayor al m√≠nimo',
            background: '#FEE2E2'
        });
    }

    // Validar Punto de Reorden
    if (puntoReorden > 0 && stockMin > 0) {
        if (puntoReorden < stockMin) {
            puntoReordenInput.style.borderColor = '#F59E0B';
            Toast.fire({
                icon: 'info',
                title: 'üí° Punto de reorden bajo',
                text: 'Se recomienda que est√© entre el m√≠nimo y m√°ximo',
                background: '#FEF3C7'
            });
        } else if (stockMax > 0 && puntoReorden > stockMax) {
            puntoReordenInput.style.borderColor = '#F59E0B';
            Toast.fire({
                icon: 'info',
                title: 'üí° Punto de reorden alto',
                text: 'Se recomienda que est√© entre el m√≠nimo y m√°ximo',
                background: '#FEF3C7'
            });
        }
    }

    // Advertencia si stock actual < m√≠nimo
    if (stockActual > 0 && stockMin > 0 && stockActual < stockMin) {
        stockActualInput.style.borderColor = '#F59E0B';
        Toast.fire({
            icon: 'warning',
            title: '‚ö†Ô∏è Stock inicial bajo',
            html: `Stock actual (${stockActual}) es menor al m√≠nimo (${stockMin})`,
            background: '#FEF3C7'
        });
    }
}

// ============================================
// VALIDACI√ìN PRINCIPAL DEL FORMULARIO
// ============================================
document.getElementById('productoForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const stockMin = parseInt(stockMinInput.value) || 0;
    const stockMax = parseInt(stockMaxInput.value) || 0;
    const puntoReorden = parseInt(puntoReordenInput.value) || 0;
    const stockActual = parseInt(stockActualInput.value) || 0;

    // Validar stock m√≠nimo (obligatorio)
    if (stockMin <= 0) {
        Swal.fire({
            icon: 'error',
            title: '‚ùå Stock m√≠nimo requerido',
            html: '<p>Debe ingresar un <strong>stock m√≠nimo</strong> mayor a 0</p>',
            confirmButtonText: 'Entendido',
            confirmButtonColor: '#2563EB'
        });
        stockMinInput.focus();
        return;
    }

    // Validar stock actual (obligatorio)
    if (stockActual < 0) {
        Swal.fire({
            icon: 'error',
            title: '‚ùå Stock actual inv√°lido',
            text: 'El stock actual no puede ser negativo',
            confirmButtonText: 'Corregir',
            confirmButtonColor: '#2563EB'
        });
        stockActualInput.focus();
        return;
    }

    // Validar relaci√≥n stock m√°ximo < m√≠nimo
    if (stockMax > 0 && stockMax < stockMin) {
        Swal.fire({
            icon: 'error',
            title: 'üö´ Configuraci√≥n inv√°lida',
            html: `
                <div style="text-align: center; margin: 1rem 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div style="background: #FEE2E2; padding: 1rem; border-radius: 8px;">
                            <strong style="color: #DC2626;">Stock M√≠nimo</strong>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #DC2626;">${stockMin}</div>
                        </div>
                        <div style="background: #FEE2E2; padding: 1rem; border-radius: 8px;">
                            <strong style="color: #DC2626;">Stock M√°ximo</strong>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #DC2626;">${stockMax}</div>
                        </div>
                    </div>
                    <p style="margin-top: 1rem; color: #DC2626; font-weight: bold;">
                        El stock m√°ximo debe ser mayor al m√≠nimo
                    </p>
                </div>
            `,
            confirmButtonText: 'Corregir',
            confirmButtonColor: '#2563EB'
        });
        stockMaxInput.focus();
        return;
    }

    // Advertencia si stock inicial muy bajo
    if (stockActual > 0 && stockActual < stockMin) {
        Swal.fire({
            icon: 'warning',
            title: '‚ö†Ô∏è Stock inicial bajo',
            html: `
                <div style="text-align: center; margin: 1rem 0;">
                    <p>El stock actual (<strong>${stockActual}</strong>) es menor al stock m√≠nimo (<strong>${stockMin}</strong>)</p>
                    <div style="background: #FEF3C7; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                        <p style="color: #92400E; margin: 0;">Esto activar√° una alerta de bajo stock inmediatamente</p>
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Continuar de todas formas',
            cancelButtonText: 'Ajustar stock',
            confirmButtonColor: '#2563EB',
            cancelButtonColor: '#6B7280'
        }).then((result) => {
            if (result.isConfirmed) {
                mostrarConfirmacionFinal(stockMin, stockMax, stockActual);
            } else {
                stockActualInput.focus();
            }
        });
        return;
    }

    // Todo correcto
    mostrarConfirmacionFinal(stockMin, stockMax, stockActual);
});

// ============================================
// CONFIRMACI√ìN FINAL
// ============================================
function mostrarConfirmacionFinal(stockMin, stockMax, stockActual) {
    const perecedero = document.getElementById('{{ form.es_perecedero.id_for_label }}').checked;
    const requiereLote = document.getElementById('{{ form.requiere_lote.id_for_label }}').checked;
    const requiereSerie = document.getElementById('{{ form.requiere_serie.id_for_label }}').checked;

    let controles = [];
    if (perecedero) controles.push('‚ö†Ô∏è Perecedero');
    if (requiereLote) controles.push('üì¶ Control por Lote');
    if (requiereSerie) controles.push('üî¢ Control por Serie');

    const textoControles = controles.length > 0 
        ? controles.join('<br>') 
        : '<span style="color: #6B7280;">Sin controles adicionales</span>';

    // Calcular nivel de alerta
    let nivelAlerta = 'success';
    let textoAlerta = 'Normal';
    let iconoAlerta = '‚úì';

    if (stockActual < stockMin) {
        nivelAlerta = 'error';
        textoAlerta = 'Bajo Stock';
        iconoAlerta = 'üö®';
    } else if (stockActual <= stockMin * 1.5) {
        nivelAlerta = 'warning';
        textoAlerta = 'Stock Justo';
        iconoAlerta = '‚ö†Ô∏è';
    }

    const bgAlerta = nivelAlerta === 'error' ? '#FEE2E2' : 
                     nivelAlerta === 'warning' ? '#FEF3C7' : '#D1FAE5';
    const colorAlerta = nivelAlerta === 'error' ? '#DC2626' : 
                        nivelAlerta === 'warning' ? '#F59E0B' : '#10B981';

    Swal.fire({
        icon: 'question',
        title: '¬øGuardar configuraci√≥n de stock?',
        html: `
            <div style="text-align: left; margin: 1.5rem 0;">
                <div style="display: grid; gap: 0.75rem; margin-bottom: 1rem;">
                    <div style="background: #F9FAFB; padding: 0.75rem; border-radius: 6px; display: flex; justify-content: space-between;">
                        <strong>üìâ Stock M√≠nimo:</strong>
                        <span style="color: #DC2626; font-weight: bold;">${stockMin}</span>
                    </div>
                    ${stockMax > 0 ? `
                        <div style="background: #F9FAFB; padding: 0.75rem; border-radius: 6px; display: flex; justify-content: space-between;">
                            <strong>üìà Stock M√°ximo:</strong>
                            <span style="color: #10B981; font-weight: bold;">${stockMax}</span>
                        </div>
                    ` : ''}
                    <div style="background: ${bgAlerta}; padding: 0.75rem; border-radius: 6px; display: flex; justify-content: space-between;">
                        <strong>üì¶ Stock Actual:</strong>
                        <span style="color: ${colorAlerta}; font-weight: bold;">${stockActual} ${iconoAlerta}</span>
                    </div>
                </div>
                <div style="background: #EFF6FF; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <strong style="color: #1F2937;">üéõÔ∏è Controles activados:</strong>
                    <div style="margin-top: 0.5rem; font-size: 0.9em;">
                        ${textoControles}
                    </div>
                </div>
                <div style="background: ${bgAlerta}; padding: 0.75rem; border-radius: 6px; margin-top: 1rem; text-align: center;">
                    <strong style="color: ${colorAlerta};">${iconoAlerta} Estado: ${textoAlerta}</strong>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: '‚úì Continuar al Paso 3 ‚Üí',
        cancelButtonText: '‚Üê Revisar',
        confirmButtonColor: '#2563EB',
        cancelButtonColor: '#6B7280',
        width: '600px',
        backdrop: `rgba(37, 99, 235, 0.1)`
    }).then((result) => {
        if (result.isConfirmed) {
            guardarPaso2();
        }
    });
}

function guardarPaso2() {
    let progreso = 0;
    const etapas = [
        { texto: 'Validando niveles de stock...', icon: 'üìä' },
        { texto: 'Configurando controles...', icon: 'üéõÔ∏è' },
        { texto: 'Preparando Paso 3...', icon: 'üöÄ' }
    ];
    let etapaActual = 0;

    Swal.fire({
        title: etapas[0].texto,
        html: `
            <div style="margin: 1.5rem 0;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">${etapas[0].icon}</div>
                <div style="background: #F3F4F6; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div id="progressBar" style="background: linear-gradient(90deg, #2563EB, #1E40AF); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <p id="progressText" style="color: #2563EB; margin-top: 0.5rem; font-weight: bold;">0%</p>
            </div>
        `,
        showConfirmButton: false,
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const interval = setInterval(() => {
                progreso += 5;
                progressBar.style.width = progreso + '%';
                progressText.textContent = progreso + '%';
                // Cambiar etapa
                if (progreso === 33 || progreso === 66) {
                    etapaActual++;
                    Swal.update({
                        title: etapas[etapaActual].texto,
                        html: `
                            <div style="margin: 1.5rem 0;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">${etapas[etapaActual].icon}</div>
                                <div style="background: #F3F4F6; height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, #2563EB, #1E40AF); height: 100%; width: ${progreso}%; transition: width 0.3s ease;"></div>
                                </div>
                                <p style="color: #2563EB; margin-top: 0.5rem; font-weight: bold;">${progreso}%</p>
                            </div>
                        `
                    });
                }
                if (progreso >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('productoForm').submit();
                    }, 500);
                }
            }, 50);
        }
    });
}

// ============================================
// LIMPIAR FORMULARIO
// ============================================
function limpiarFormulario() {
    Swal.fire({
        icon: 'warning',
        title: 'üîÑ ¬øLimpiar configuraci√≥n?',
        text: 'Se perder√°n los datos de stock y controles',
        showCancelButton: true,
        confirmButtonText: 'S√≠, limpiar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#F59E0B',
        cancelButtonColor: '#6B7280'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('productoForm').reset();
            // Resetear checkboxes
            updateCheckbox('{{ form.es_perecedero.id_for_label }}', 'perishable');
            updateCheckbox('{{ form.requiere_lote.id_for_label }}', 'lote');
            updateCheckbox('{{ form.requiere_serie.id_for_label }}', 'serie');
            // Resetear estilos
            [stockMinInput, stockMaxInput, puntoReordenInput, stockActualInput].forEach(input => {
                if (input) {
                    input.style.borderColor = 'var(--border)';
                    input.style.boxShadow = '';
                }
            });
            Toast.fire({
                icon: 'success',
                title: '‚úì Configuraci√≥n limpiada',
                background: '#D1FAE5'
            });
        }
    });
}
</script>
{% endblock %}