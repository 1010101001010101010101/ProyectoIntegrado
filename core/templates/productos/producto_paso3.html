{% extends 'base.html' %}

{% block title %}Nuevo Producto - Paso 3{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #2563eb;
        --primary-dark: #1e40af;
        --text-dark: #1f2937;
        --text-gray: #6b7280;
        --border: #e5e7eb;
        --shadow: rgba(0, 0, 0, 0.1);
    }
    
    .wizard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .wizard-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .wizard-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
    }
    
    /* WIZARD STEPS */
    .wizard-steps {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px var(--shadow);
    }
    
    .step {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        transition: all 0.3s ease;
        background: #f9fafb;
    }
    
    .step.completed {
        background: #22c55e;
        color: white;
    }
    
    .step.active {
        background: var(--primary);
        color: white;
    }
    
    .step-number {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
    }
    
    .step.completed .step-number {
        background: white;
        color: #22c55e;
    }
    
    .step.active .step-number {
        background: white;
        color: var(--primary);
    }
    
    /* FORM CARD */
    .form-card {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 12px var(--shadow);
    }
    
    .section-title {
        font-size: 1.1rem;
        color: var(--text-dark);
        font-weight: 700;
        margin: 1.5rem 0 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--border);
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        font-weight: 600;
        margin-bottom: 0.4rem;
        color: var(--text-dark);
        font-size: 0.9rem;
    }
    
    .label-hint {
        font-size: 0.75rem;
        color: var(--text-gray);
        margin-top: 0.25rem;
    }
    
    .form-control {
        padding: 0.75rem;
        border: 2px solid var(--border);
        border-radius: 6px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .form-control[readonly] {
        background: #f9fafb;
        cursor: not-allowed;
        color: var(--text-gray);
        border-color: #e5e7eb;
    }
    
    .form-control.error {
        border-color: #dc2626;
        background: #fef2f2;
    }
    
    /* READONLY SECTION */
    .readonly-section {
        background: #f9fafb;
        border: 2px dashed #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    /* FORM ACTIONS */
    .form-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 2px solid var(--border);
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
    }
    
    .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    
    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
    }
    
    .btn-secondary {
        background: #f3f4f6;
        color: var(--text-dark);
    }
    
    .btn-secondary:hover {
        background: #e5e7eb;
    }
    
    .info-box {
        background: #f0f9ff;
        border-left: 4px solid var(--primary);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .info-box p {
        margin: 0;
        color: var(--text-dark);
        font-size: 0.9rem;
    }
    
    .error-message {
        color: #dc2626;
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
    <div class="wizard-header">
        <h1 class="wizard-title">üì¶ Formulario de Producto</h1>
    </div>

    <!-- WIZARD STEPS -->
    <div class="wizard-steps">
        <div class="step completed">
            <div class="step-number">‚úì</div>
            <div class="step-label">Identificaci√≥n y precios</div>
        </div>
        <div class="step completed">
            <div class="step-number">‚úì</div>
            <div class="step-label">Stock y control</div>
        </div>
        <div class="step active">
            <div class="step-number">3</div>
            <div class="step-label">Relaciones y derivados</div>
        </div>
    </div>

    <div class="form-card">
        <form method="POST" id="productoForm" novalidate>
            {% csrf_token %}
            
            <h3 class="section-title">üîó Relaciones y soporte</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="imagen_url">URL de Imagen <span style="color:var(--text-gray);">(opcional)</span></label>
                    <input 
                        type="url" 
                        id="imagen_url" 
                        name="imagen_url" 
                        class="form-control" 
                        value="{{ data.imagen_url|default:'' }}" 
                        placeholder="https://.../foto.jpg"
                    >
                    <span class="label-hint">URL completa de la imagen del producto</span>
                </div>
                
                <div class="form-group">
                    <label for="ficha_tecnica_url">URL de Ficha T√©cnica <span style="color:var(--text-gray);">(opcional)</span></label>
                    <input 
                        type="url" 
                        id="ficha_tecnica_url" 
                        name="ficha_tecnica_url" 
                        class="form-control" 
                        value="{{ data.ficha_tecnica_url|default:'' }}" 
                        placeholder="https://.../ficha.pdf"
                    >
                    <span class="label-hint">URL completa de la ficha t√©cnica</span>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.proveedor_principal.id_for_label }}">Proveedor principal</label>
                    {{ form.proveedor_principal }}
                    {% if form.proveedor_principal.errors %}
                        <span class="error-message">{{ form.proveedor_principal.errors.0 }}</span>
                    {% else %}
                        <span class="label-hint">Selecciona el proveedor que abastece este producto</span>
                    {% endif %}
                </div>

                <div class="form-group" style="align-self: flex-end;">
                    <a href="{% url 'core:proveedor_paso1' %}?next={{ request.path }}" target="_blank" class="btn btn-secondary" style="justify-content:center;">
                        ‚ûï Crear nuevo proveedor
                    </a>
                    <span class="label-hint">Se abre en otra pesta√±a; vuelve y actualiza la lista si lo creas.</span>
                </div>
            </div>

            <h3 class="section-title">üìä Derivados (solo lectura)</h3>
            
            <div class="info-box">
                <p><strong>‚ÑπÔ∏è Informaci√≥n:</strong> Estos campos se calculan autom√°ticamente seg√∫n el stock m√≠nimo configurado.</p>
            </div>
            
            <div class="readonly-section">
                <div class="form-row">
                    <div class="form-group">
                        <label for="stock_actual">Stock Actual</label>
                        <input 
                            type="number" 
                            id="stock_actual" 
                            class="form-control" 
                            value="0" 
                            readonly
                            title="Este campo se calcula autom√°ticamente"
                        >
                        <span class="label-hint">Calculado autom√°ticamente</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="alerta_bajo_stock">Alerta Bajo Stock</label>
                        <input 
                            type="text" 
                            id="alerta_bajo_stock" 
                            class="form-control" 
                            value="S√ç" 
                            readonly
                            title="Este campo se calcula autom√°ticamente"
                        >
                        <span class="label-hint">Basado en stock m√≠nimo</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="alerta_por_vencer">Alerta Por Vencer</label>
                        <input 
                            type="text" 
                            id="alerta_por_vencer" 
                            class="form-control" 
                            value="NO" 
                            readonly
                            title="Este campo se calcula autom√°ticamente"
                        >
                        <span class="label-hint">Solo si es perecedero</span>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <a href="{% url 'core:producto_paso2' %}" class="btn btn-secondary">
                    ‚Üê Anterior
                </a>
                <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">
                    üîÑ Limpiar
                </button>
                <button type="submit" class="btn btn-primary">
                    üíæ Guardar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// ============================================
// VALIDACI√ìN EN TIEMPO REAL
// ============================================

// Funci√≥n para validar URLs
function validarURL(url) {
    if (!url) return true; // URLs vac√≠as son v√°lidas (opcional)
    
    try {
        const urlObj = new URL(url);
        return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
    } catch (e) {
        return false;
    }
}

// Validaci√≥n de URL de imagen
document.getElementById('imagen_url').addEventListener('blur', function(e) {
    const url = e.target.value.trim();
    
    if (url && !validarURL(url)) {
        e.target.classList.add('error');
        Swal.fire({
            icon: 'warning',
            title: 'URL inv√°lida',
            text: 'La URL de imagen no es v√°lida. Debe comenzar con http:// o https://',
            timer: 3000,
            toast: true,
            position: 'top-end',
            showConfirmButton: false
        });
    } else {
        e.target.classList.remove('error');
    }
});

// Validaci√≥n de URL de ficha t√©cnica
document.getElementById('ficha_tecnica_url').addEventListener('blur', function(e) {
    const url = e.target.value.trim();
    
    if (url && !validarURL(url)) {
        e.target.classList.add('error');
        Swal.fire({
            icon: 'warning',
            title: 'URL inv√°lida',
            text: 'La URL de ficha t√©cnica no es v√°lida. Debe comenzar con http:// o https://',
            timer: 3000,
            toast: true,
            position: 'top-end',
            showConfirmButton: false
        });
    } else {
        e.target.classList.remove('error');
    }
});

// Prevenir edici√≥n de campos readonly con feedback
const readonlyFields = document.querySelectorAll('input[readonly]');
readonlyFields.forEach(field => {
    field.addEventListener('click', function() {
        Swal.fire({
            icon: 'info',
            title: 'Campo de solo lectura',
            text: 'Este campo se calcula autom√°ticamente y no puede ser editado',
            timer: 2000,
            toast: true,
            position: 'top-end',
            showConfirmButton: false
        });
    });
});

// ============================================
// VALIDACI√ìN AL ENVIAR
// ============================================
document.getElementById('productoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Obtener valores
    const imagenUrl = document.getElementById('imagen_url').value.trim();
    const fichaTecnicaUrl = document.getElementById('ficha_tecnica_url').value.trim();
    
    // Validar URL de imagen
    if (imagenUrl && !validarURL(imagenUrl)) {
        Swal.fire({
            icon: 'error',
            title: 'URL de imagen inv√°lida',
            text: 'Por favor ingrese una URL v√°lida para la imagen (debe comenzar con http:// o https://)',
            confirmButtonText: 'Corregir'
        });
        document.getElementById('imagen_url').classList.add('error');
        document.getElementById('imagen_url').focus();
        return;
    }
    
    // Validar URL de ficha t√©cnica
    if (fichaTecnicaUrl && !validarURL(fichaTecnicaUrl)) {
        Swal.fire({
            icon: 'error',
            title: 'URL de ficha t√©cnica inv√°lida',
            text: 'Por favor ingrese una URL v√°lida para la ficha t√©cnica (debe comenzar con http:// o https://)',
            confirmButtonText: 'Corregir'
        });
        document.getElementById('ficha_tecnica_url').classList.add('error');
        document.getElementById('ficha_tecnica_url').focus();
        return;
    }
    
    // Preparar resumen
    let resumenHTML = '<div style="text-align: left; margin-top: 1rem; font-size: 0.95rem;">';
    
    if (imagenUrl) {
        resumenHTML += '<p><strong>üñºÔ∏è Imagen:</strong> Configurada</p>';
    }
    
    if (fichaTecnicaUrl) {
        resumenHTML += '<p><strong>üìÑ Ficha t√©cnica:</strong> Configurada</p>';
    }
    
    if (!imagenUrl && !fichaTecnicaUrl) {
        resumenHTML += '<p style="color: var(--text-gray);">üì≠ Sin documentos adicionales</p>';
    }
    
    resumenHTML += '<hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--border);">';
    resumenHTML += '<p><strong>‚úÖ Stock inicial:</strong> 0 unidades</p>';
    resumenHTML += '<p><strong>‚ö†Ô∏è Alerta bajo stock:</strong> Activada</p>';
    resumenHTML += '</div>';
    
    // Confirmaci√≥n final
    Swal.fire({
        icon: 'question',
        title: '¬øConfirmar creaci√≥n del producto?',
        html: `
            <p style="color: var(--text-gray); margin-bottom: 1rem;">
                Est√°s a punto de crear un nuevo producto con toda la informaci√≥n ingresada en los 3 pasos.
            </p>
            ${resumenHTML}
        `,
        showCancelButton: true,
        confirmButtonText: '‚úì S√≠, crear producto',
        cancelButtonText: 'Revisar datos',
        customClass: {
            popup: 'swal2-popup',
            confirmButton: 'swal2-confirm',
            cancelButton: 'swal2-cancel'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            guardarProducto();
        }
    });
});

function guardarProducto() {
    Swal.fire({
        icon: 'success',
        title: '‚úì Guardando producto...',
        html: `
            <div style="margin-top: 1rem;">
                <p>Procesando informaci√≥n de los 3 pasos</p>
                <div style="margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; border-radius: 8px;">
                    <p style="margin: 0; color: var(--primary); font-size: 0.9rem;">
                        ‚è≥ Creando producto en el sistema...
                    </p>
                </div>
            </div>
        `,
        timer: 2000,
        showConfirmButton: false,
        timerProgressBar: true,
        allowOutsideClick: false,
        allowEscapeKey: false,
        willClose: () => {
            document.getElementById('productoForm').submit();
        }
    });
}

function limpiarFormulario() {
    Swal.fire({
        icon: 'warning',
        title: '¬øLimpiar URLs?',
        text: 'Se borrar√°n las URLs ingresadas en este paso',
        showCancelButton: true,
        confirmButtonText: 'S√≠, limpiar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('productoForm').reset();
            
            // Remover clases de error
            document.getElementById('imagen_url').classList.remove('error');
            document.getElementById('ficha_tecnica_url').classList.remove('error');
            
            Swal.fire({
                icon: 'success',
                title: '‚úì URLs limpiadas',
                timer: 1500,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });
        }
    });
}

// ============================================
// SUGERENCIAS INTELIGENTES
// ============================================

// Sugerencia si agrega imagen pero no ficha t√©cnica
document.getElementById('imagen_url').addEventListener('blur', function(e) {
    const imagenUrl = e.target.value.trim();
    const fichaTecnicaUrl = document.getElementById('ficha_tecnica_url').value.trim();
    
    if (imagenUrl && validarURL(imagenUrl) && !fichaTecnicaUrl) {
        setTimeout(() => {
            Swal.fire({
                icon: 'info',
                title: 'Sugerencia',
                text: '¬øDeseas agregar tambi√©n una ficha t√©cnica?',
                timer: 3000,
                toast: true,
                position: 'top-end',
                showConfirmButton: false
            });
        }, 500);
    }
});

// Detectar extensi√≥n de archivo y advertir si no es apropiada
document.getElementById('imagen_url').addEventListener('blur', function(e) {
    const url = e.target.value.trim();
    
    if (url && validarURL(url)) {
        const extensionesImagen = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg'];
        const tieneExtensionValida = extensionesImagen.some(ext => url.toLowerCase().includes(ext));
        
        if (!tieneExtensionValida) {
            Swal.fire({
                icon: 'info',
                title: 'Formato de imagen',
                html: 'La URL no parece terminar en una extensi√≥n de imagen com√∫n (.jpg, .png, etc.)<br><small>Verifica que sea una URL de imagen v√°lida</small>',
                timer: 4000,
                toast: true,
                position: 'top-end',
                showConfirmButton: false
            });
        }
    }
});

document.getElementById('ficha_tecnica_url').addEventListener('blur', function(e) {
    const url = e.target.value.trim();
    
    if (url && validarURL(url)) {
        const extensionesDocumento = ['.pdf', '.doc', '.docx', '.xls', '.xlsx'];
        const tieneExtensionValida = extensionesDocumento.some(ext => url.toLowerCase().includes(ext));
        
        if (!tieneExtensionValida) {
            Swal.fire({
                icon: 'info',
                title: 'Formato de documento',
                html: 'La URL no parece terminar en una extensi√≥n de documento com√∫n (.pdf, .doc, etc.)<br><small>Verifica que sea una URL de documento v√°lida</small>',
                timer: 4000,
                toast: true,
                position: 'top-end',
                showConfirmButton: false
            });
        }
    }
});
</script>
{% endblock %}