{% extends 'base.html' %}

{% block title %}Nuevo Producto - Paso 1{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #2563eb;
        --primary-dark: #1e40af;
        --text-dark: #1f2937;
        --text-gray: #6b7280;
        --border: #e5e7eb;
        --shadow: rgba(0, 0, 0, 0.1);
    }
    
    .wizard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .wizard-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .wizard-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
    }
    
    /* WIZARD STEPS */
    .wizard-steps {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px var(--shadow);
    }
    
    .step {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .step.active {
        background: var(--primary);
        color: white;
    }
    
    .step-number {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
    }
    
    .step.active .step-number {
        background: white;
        color: var(--primary);
    }
    
    /* FORM CARD */
    .form-card {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 12px var(--shadow);
    }
    
    .section-title {
        font-size: 1.1rem;
        color: var(--text-dark);
        font-weight: 700;
        margin: 1.5rem 0 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--border);
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        font-weight: 600;
        margin-bottom: 0.4rem;
        color: var(--text-dark);
        font-size: 0.9rem;
    }
    
    .label-hint {
        font-size: 0.75rem;
        color: var(--text-gray);
        margin-top: 0.25rem;
    }
    
    .form-control {
        padding: 0.75rem;
        border: 2px solid var(--border);
        border-radius: 6px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .form-control[readonly] {
        background: #f9fafb;
        color: var(--text-gray);
    }
    
    textarea.form-control {
        min-height: 80px;
        resize: vertical;
        font-family: inherit;
    }
    
    /* FORM ACTIONS */
    .form-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 2px solid var(--border);
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
    }
    
    .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    
    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
    }
    
    .btn-secondary {
        background: #f3f4f6;
        color: var(--text-dark);
    }
    
    .btn-secondary:hover {
        background: #e5e7eb;
    }
    
    .error-message {
        color: #dc2626;
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
    <div class="wizard-header">
        <h1 class="wizard-title">üì¶ Formulario de Producto</h1>
    </div>

    <!-- WIZARD STEPS -->
    <div class="wizard-steps">
        <div class="step active">
            <div class="step-number">1</div>
            <div class="step-label">Identificaci√≥n y precios</div>
        </div>
        <div class="step">
            <div class="step-number">2</div>
            <div class="step-label">Stock y control</div>
        </div>
        <div class="step">
            <div class="step-number">3</div>
            <div class="step-label">Relaciones y derivados</div>
        </div>
    </div>

    <div class="form-card">
        <!-- ‚ö†Ô∏è AGREGAMOS novalidate AQU√ç -->
        <form method="POST" id="productoForm" novalidate>
            {% csrf_token %}
            
            <h3 class="section-title">Identificaci√≥n</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.sku.id_for_label }}">{{ form.sku.label }} <span style="color:#dc2626;">*</span></label>
                    {{ form.sku }}
                    {% if form.sku.errors %}
                        <span class="error-message">{{ form.sku.errors.0 }}</span>
                    {% else %}
                        <span class="label-hint">{{ form.sku.help_text }}</span>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.ean_upc.id_for_label }}">{{ form.ean_upc.label }}</label>
                    {{ form.ean_upc }}
                    {% if form.ean_upc.errors %}
                        <span class="error-message">{{ form.ean_upc.errors.0 }}</span>
                    {% else %}
                        <span class="label-hint">{{ form.ean_upc.help_text }}</span>
                    {% endif %}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label for="{{ form.nombre.id_for_label }}">{{ form.nombre.label }} <span style="color:#dc2626;">*</span></label>
                    {{ form.nombre }}
                    {% if form.nombre.errors %}
                        <span class="error-message">{{ form.nombre.errors.0 }}</span>
                    {% endif %}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label for="{{ form.descripcion.id_for_label }}">{{ form.descripcion.label }}</label>
                    {{ form.descripcion }}
                    {% if form.descripcion.errors %}
                        <span class="error-message">{{ form.descripcion.errors.0 }}</span>
                    {% endif %}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.categoria.id_for_label }}">{{ form.categoria.label }} <span style="color:#dc2626;">*</span></label>
                    {{ form.categoria }}
                    {% if form.categoria.errors %}
                        <span class="error-message">{{ form.categoria.errors.0 }}</span>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.marca.id_for_label }}">{{ form.marca.label }}</label>
                    {{ form.marca }}
                    {% if form.marca.errors %}
                        <span class="error-message">{{ form.marca.errors.0 }}</span>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.modelo.id_for_label }}">{{ form.modelo.label }}</label>
                    {{ form.modelo }}
                    {% if form.modelo.errors %}
                        <span class="error-message">{{ form.modelo.errors.0 }}</span>
                    {% endif %}
                </div>
            </div>

            <h3 class="section-title">Unidades y precios</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.uom_compra.id_for_label }}">{{ form.uom_compra.label }} <span style="color:#dc2626;">*</span></label>
                    {{ form.uom_compra }}
                    {% if form.uom_compra.errors %}
                        <span class="error-message">{{ form.uom_compra.errors.0 }}</span>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.uom_venta.id_for_label }}">{{ form.uom_venta.label }} <span style="color:#dc2626;">*</span></label>
                    {{ form.uom_venta }}
                    {% if form.uom_venta.errors %}
                        <span class="error-message">{{ form.uom_venta.errors.0 }}</span>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.factor_conversion.id_for_label }}">{{ form.factor_conversion.label }} <span style="color:#dc2626;">*</span></label>
                    {{ form.factor_conversion }}
                    {% if form.factor_conversion.errors %}
                        <span class="error-message">{{ form.factor_conversion.errors.0 }}</span>
                    {% else %}
                        <span class="label-hint">{{ form.factor_conversion.help_text }}</span>
                    {% endif %}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.costo_estandar.id_for_label }}">{{ form.costo_estandar.label }}</label>
                    {{ form.costo_estandar }}
                    {% if form.costo_estandar.errors %}
                        <span class="error-message">{{ form.costo_estandar.errors.0 }}</span>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.costo_promedio.id_for_label }}">{{ form.costo_promedio.label }}</label>
                    {{ form.costo_promedio }}
                    <span class="label-hint">{{ form.costo_promedio.help_text }}</span>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.precio_venta.id_for_label }}">{{ form.precio_venta.label }}</label>
                    {{ form.precio_venta }}
                    {% if form.precio_venta.errors %}
                        <span class="error-message">{{ form.precio_venta.errors.0 }}</span>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.impuesto_iva.id_for_label }}">{{ form.impuesto_iva.label }} <span style="color:#dc2626;">*</span></label>
                    {{ form.impuesto_iva }}
                    {% if form.impuesto_iva.errors %}
                        <span class="error-message">{{ form.impuesto_iva.errors.0 }}</span>
                    {% endif %}
                </div>
            </div>

            <div class="form-actions">
                <a href="{% url 'core:lista_productos' %}" class="btn btn-secondary">
                    ‚ùå Cancelar
                </a>
                <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">
                    üîÑ Limpiar
                </button>
                <button type="submit" class="btn btn-primary">
                    üíæ Guardar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// ============================================
// VALIDACI√ìN COMPLETA DEL FORMULARIO
// ============================================
document.getElementById('productoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // ============================================
    // RECOPILAR TODOS LOS CAMPOS
    // ============================================
    const skuInput = document.getElementById('{{ form.sku.id_for_label }}');
    const nombreInput = document.getElementById('{{ form.nombre.id_for_label }}');
    const categoriaInput = document.getElementById('{{ form.categoria.id_for_label }}');
    const uomCompraInput = document.getElementById('{{ form.uom_compra.id_for_label }}');
    const uomVentaInput = document.getElementById('{{ form.uom_venta.id_for_label }}');
    const factorConversionInput = document.getElementById('{{ form.factor_conversion.id_for_label }}');
    const impuestoIvaInput = document.getElementById('{{ form.impuesto_iva.id_for_label }}');
    const costoEstandarInput = document.getElementById('id_costo_estandar');
    const precioVentaInput = document.getElementById('id_precio_venta');
    
    const sku = skuInput.value.trim();
    const nombre = nombreInput.value.trim();
    const categoria = categoriaInput.value;
    const uomCompra = uomCompraInput.value;
    const uomVenta = uomVentaInput.value;
    const factorConversion = factorConversionInput.value.trim();
    const impuestoIva = impuestoIvaInput.value.trim();
    
    // ============================================
    // VALIDAR CAMPOS OBLIGATORIOS
    // ============================================
    let camposFaltantes = [];
    let primerCampoError = null;
    
    // Validar SKU
    if (!sku) {
        camposFaltantes.push('üì¶ SKU (C√≥digo del producto)');
        if (!primerCampoError) primerCampoError = skuInput;
    } else if (sku.length < 3) {
        Swal.fire({
            icon: 'error',
            title: 'SKU inv√°lido',
            text: 'El SKU debe tener al menos 3 caracteres',
            confirmButtonText: 'Corregir'
        });
        skuInput.focus();
        return;
    }
    
    // Validar Nombre
    if (!nombre) {
        camposFaltantes.push('üè∑Ô∏è Nombre del producto');
        if (!primerCampoError) primerCampoError = nombreInput;
    } else if (nombre.length < 3) {
        Swal.fire({
            icon: 'error',
            title: 'Nombre inv√°lido',
            text: 'El nombre debe tener al menos 3 caracteres',
            confirmButtonText: 'Corregir'
        });
        nombreInput.focus();
        return;
    }
    
    // Validar Categor√≠a
    if (!categoria) {
        camposFaltantes.push('üìÅ Categor√≠a');
        if (!primerCampoError) primerCampoError = categoriaInput;
    }
    
    // Validar Unidad de Compra
    if (!uomCompra) {
        camposFaltantes.push('üì• Unidad de Compra');
        if (!primerCampoError) primerCampoError = uomCompraInput;
    }
    
    // Validar Unidad de Venta
    if (!uomVenta) {
        camposFaltantes.push('üì§ Unidad de Venta');
        if (!primerCampoError) primerCampoError = uomVentaInput;
    }
    
    // Validar Factor de Conversi√≥n
    const factorNum = parseFloat(factorConversion);
    if (!factorConversion || isNaN(factorNum) || factorNum <= 0) {
        camposFaltantes.push('üîÑ Factor de Conversi√≥n (debe ser mayor a 0)');
        if (!primerCampoError) primerCampoError = factorConversionInput;
    } else if (factorNum > 10000) {
        Swal.fire({
            icon: 'error',
            title: 'Factor de conversi√≥n inv√°lido',
            text: 'El factor de conversi√≥n no puede superar 10,000',
            confirmButtonText: 'Corregir'
        });
        factorConversionInput.focus();
        return;
    }
    
    // Validar IVA
    const ivaNum = parseFloat(impuestoIva);
    if (!impuestoIva || isNaN(ivaNum)) {
        camposFaltantes.push('üßæ IVA (%)');
        if (!primerCampoError) primerCampoError = impuestoIvaInput;
    } else if (ivaNum < 0 || ivaNum > 100) {
        Swal.fire({
            icon: 'error',
            title: 'IVA inv√°lido',
            text: 'El IVA debe estar entre 0% y 100%',
            confirmButtonText: 'Corregir'
        });
        impuestoIvaInput.focus();
        return;
    }
    
    // ============================================
    // MOSTRAR ALERTA SI HAY CAMPOS FALTANTES
    // ============================================
    if (camposFaltantes.length > 0) {
        let listaCampos = '<ul style="text-align: left; margin: 1rem 0; padding-left: 1.5rem;">';
        camposFaltantes.forEach(campo => {
            listaCampos += `<li style="margin: 0.5rem 0;">${campo}</li>`;
        });
        listaCampos += '</ul>';
        
        Swal.fire({
            icon: 'error',
            title: '‚ùå Faltan campos obligatorios',
            html: `
                <p style="margin-bottom: 1rem;">Debes completar los siguientes campos para continuar al siguiente paso:</p>
                ${listaCampos}
                <p style="margin-top: 1rem; color: #dc2626; font-weight: 600;">
                    Total de campos faltantes: ${camposFaltantes.length}
                </p>
            `,
            confirmButtonText: 'Entendido',
            customClass: {
                popup: 'swal2-popup-large',
                confirmButton: 'swal2-confirm'
            },
            willClose: () => {
                // Hacer foco en el primer campo con error
                if (primerCampoError) {
                    primerCampoError.focus();
                    primerCampoError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
        return;
    }
    
    // ============================================
    // VALIDAR PRECIOS (Solo si est√°n completos)
    // ============================================
    const costoEst = parseInt(costoEstandarInput.value.replace(/\D/g, '')) || 0;
    const precioVta = parseInt(precioVentaInput.value.replace(/\D/g, '')) || 0;
    
    // Validar l√≠mites de precios
    if (costoEst > 10000000) {
        Swal.fire({
            icon: 'error',
            title: 'Costo muy alto',
            text: 'El costo est√°ndar no puede superar $10,000,000',
            confirmButtonText: 'Corregir'
        });
        costoEstandarInput.focus();
        return;
    }
    
    if (precioVta > 100000000) {
        Swal.fire({
            icon: 'error',
            title: 'Precio muy alto',
            text: 'El precio de venta no puede superar $100,000,000',
            confirmButtonText: 'Corregir'
        });
        precioVentaInput.focus();
        return;
    }
    
    // Validar que precio sea mayor al costo
    if (precioVta > 0 && costoEst > 0 && precioVta < costoEst) {
        Swal.fire({
            icon: 'error',
            title: 'Precio menor al costo',
            html: `
                <p>El precio de venta (<strong>$${precioVta.toLocaleString('es-CL')}</strong>) no puede ser menor al costo est√°ndar (<strong>$${costoEst.toLocaleString('es-CL')}</strong>).</p>
                <p style="color: #dc2626; margin-top: 1rem;">Esto generar√° p√©rdidas en cada venta.</p>
            `,
            confirmButtonText: 'Corregir',
            showCancelButton: true,
            cancelButtonText: 'Continuar de todas formas'
        }).then((result) => {
            if (result.isConfirmed) {
                precioVentaInput.focus();
            } else if (result.isDismissed && result.dismiss === Swal.DismissReason.cancel) {
                mostrarConfirmacionFinal(sku, nombre, uomCompra, uomVenta, factorConversion, impuestoIva, costoEst, precioVta);
            }
        });
        return;
    }
    
    // ============================================
    // TODO CORRECTO - MOSTRAR CONFIRMACI√ìN FINAL
    // ============================================
    mostrarConfirmacionFinal(sku, nombre, uomCompra, uomVenta, factorConversion, impuestoIva, costoEst, precioVta);
});

// ============================================
// FUNCI√ìN DE CONFIRMACI√ìN FINAL
// ============================================
function mostrarConfirmacionFinal(sku, nombre, uomCompra, uomVenta, factorConversion, impuestoIva, costoEst, precioVta) {
    const margen = costoEst > 0 && precioVta > 0 ? ((precioVta - costoEst) / costoEst * 100) : 0;
    
    let resumenHTML = `
        <div style="text-align: left; margin-top: 1rem; font-size: 0.95rem;">
            <p><strong>üì¶ SKU:</strong> ${sku}</p>
            <p><strong>üè∑Ô∏è Nombre:</strong> ${nombre}</p>
            <hr style="margin: 1rem 0; border: none; border-top: 1px solid #e5e7eb;">
    `;
    
    if (costoEst > 0) {
        resumenHTML += `<p><strong>üí∞ Costo est√°ndar:</strong> $${costoEst.toLocaleString('es-CL')}</p>`;
    }
    
    if (precioVta > 0) {
        resumenHTML += `<p><strong>üíµ Precio de venta:</strong> $${precioVta.toLocaleString('es-CL')}</p>`;
    }
    
    if (margen > 0) {
        let colorMargen = margen < 10 ? '#f59e0b' : margen < 20 ? '#22c55e' : '#16a34a';
        resumenHTML += `<p><strong>üìà Margen:</strong> <span style="color: ${colorMargen}; font-weight: 700;">${margen.toFixed(1)}%</span></p>`;
    }
    
    resumenHTML += `<p><strong>üßæ IVA:</strong> ${impuestoIva}%</p>`;
    resumenHTML += '</div>';
    
    Swal.fire({
        icon: 'question',
        title: '¬øGuardar y continuar?',
        html: `
            <p style="color: var(--text-gray); margin-bottom: 0.5rem;">
                Se guardar√° el <strong>Paso 1</strong> y continuar√°s al <strong>Paso 2</strong>
            </p>
            ${resumenHTML}
        `,
        showCancelButton: true,
        confirmButtonText: '‚úì S√≠, continuar al Paso 2',
        cancelButtonText: 'Revisar datos',
        reverseButtons: true,
        customClass: {
            popup: 'swal2-popup-large',
            confirmButton: 'swal2-confirm',
            cancelButton: 'swal2-cancel'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            guardarPaso1();
        }
    });
}

// ============================================
// FUNCI√ìN PARA GUARDAR
// ============================================
function guardarPaso1() {
    Swal.fire({
        icon: 'success',
        title: '‚úì Guardando Paso 1...',
        html: `
            <div style="margin-top: 1rem;">
                <p>Procesando informaci√≥n b√°sica del producto</p>
                <div style="margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; border-radius: 8px;">
                    <p style="margin: 0; color: var(--primary); font-size: 0.9rem;">
                        ‚è≥ Preparando Paso 2...
                    </p>
                </div>
            </div>
        `,
        timer: 2000,
        showConfirmButton: false,
        timerProgressBar: true,
        allowOutsideClick: false,
        allowEscapeKey: false,
        willClose: () => {
            document.getElementById('productoForm').submit();
        }
    });
}

// ============================================
// LIMPIAR FORMULARIO
// ============================================
function limpiarFormulario() {
    Swal.fire({
        icon: 'warning',
        title: '¬øLimpiar formulario?',
        text: 'Se perder√°n todos los datos ingresados en el Paso 1',
        showCancelButton: true,
        confirmButtonText: 'S√≠, limpiar',
        cancelButtonText: 'Cancelar',
        reverseButtons: true
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('productoForm').reset();
            
            Swal.fire({
                icon: 'success',
                title: '‚úì Formulario limpiado',
                text: 'Puedes comenzar de nuevo',
                timer: 1500,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });
        }
    });
}

// ============================================
// VALIDACIONES EN TIEMPO REAL
// ============================================

// SKU - Solo may√∫sculas y alfanum√©ricos
document.getElementById('{{ form.sku.id_for_label }}').addEventListener('input', function(e) {
    e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9\-_]/g, '');
});

// EAN/UPC - Solo n√∫meros
const eanInput = document.getElementById('{{ form.ean_upc.id_for_label }}');
if (eanInput) {
    eanInput.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '').substring(0, 13);
    });
}

// Factor - No negativos
document.getElementById('{{ form.factor_conversion.id_for_label }}').addEventListener('input', function(e) {
    if (parseFloat(e.target.value) < 0) {
        e.target.value = '';
    }
});

// IVA - L√≠mite 0-100
document.getElementById('{{ form.impuesto_iva.id_for_label }}').addEventListener('input', function(e) {
    let valor = parseFloat(e.target.value);
    if (valor > 100) e.target.value = 100;
    if (valor < 0) e.target.value = 0;
});

// Toast al seleccionar categor√≠a
document.getElementById('{{ form.categoria.id_for_label }}').addEventListener('change', function(e) {
    if (e.target.value) {
        const texto = e.target.options[e.target.selectedIndex].text;
        Swal.fire({
            icon: 'success',
            title: `‚úì ${texto}`,
            text: 'Categor√≠a seleccionada',
            timer: 1500,
            showConfirmButton: false,
            toast: true,
            position: 'top-end'
        });
    }
});

// ============================================
// VALIDACIONES DE PRECIOS - SOLO ENTEROS
// ============================================
function validarEnteroPrecios(input) {
    input.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^\d]/g, '');
        if (e.target.value.length > 1) {
            e.target.value = e.target.value.replace(/^0+/, '');
        }
        e.target.classList.remove('error');
    });
    
    input.addEventListener('blur', function(e) {
        const valor = parseInt(e.target.value.replace(/\D/g, '')) || 0;
        
        if (e.target.id === 'id_costo_estandar' && valor > 10000000) {
            e.target.classList.add('error');
            Swal.fire({
                icon: 'warning',
                title: 'Precio muy alto',
                text: 'El costo est√°ndar no puede superar $10,000,000',
                timer: 3000,
                toast: true,
                position: 'top-end',
                showConfirmButton: false
            });
            e.target.value = '10000000';
        }
        
        if (e.target.id === 'id_precio_venta' && valor > 100000000) {
            e.target.classList.add('error');
            Swal.fire({
                icon: 'warning',
                title: 'Precio muy alto',
                text: 'El precio de venta no puede superar $100,000,000',
                timer: 3000,
                toast: true,
                position: 'top-end',
                showConfirmButton: false
            });
            e.target.value = '100000000';
        }
    });
}

const costoEstandar = document.getElementById('id_costo_estandar');
const costoPromedio = document.getElementById('id_costo_promedio');
const precioVenta = document.getElementById('id_precio_venta');

if (costoEstandar) validarEnteroPrecios(costoEstandar);
if (precioVenta) validarEnteroPrecios(precioVenta);

// Prevenir edici√≥n del costo promedio
if (costoPromedio) {
    costoPromedio.addEventListener('click', function() {
        Swal.fire({
            icon: 'info',
            title: 'Campo de solo lectura',
            text: 'El costo promedio se calcula autom√°ticamente seg√∫n los movimientos de inventario',
            timer: 3000,
            toast: true,
            position: 'top-end',
            showConfirmButton: false
        });
    });
    
    costoPromedio.addEventListener('keydown', function(e) {
        e.preventDefault();
    });
}

// Validar margen al perder foco en precio
if (precioVenta && costoEstandar) {
    precioVenta.addEventListener('blur', function() {
        const precio = parseInt(precioVenta.value.replace(/\D/g, '')) || 0;
        const costo = parseInt(costoEstandar.value.replace(/\D/g, '')) || 0;
        
        if (precio > 0 && costo > 0) {
            const margen = ((precio - costo) / costo * 100);
            
            if (precio < costo) {
                precioVenta.classList.add('error');
                Swal.fire({
                    icon: 'warning',
                    title: 'Precio menor al costo',
                    html: `<p>El precio de venta (<strong>$${precio.toLocaleString('es-CL')}</strong>) es menor al costo est√°ndar (<strong>$${costo.toLocaleString('es-CL')}</strong>).</p><p style="color: #dc2626;">Esto generar√° p√©rdidas.</p>`,
                    confirmButtonText: 'Entendido'
                });
            } else if (margen < 10) {
                Swal.fire({
                    icon: 'info',
                    title: 'Margen bajo',
                    html: `<p>El margen de ganancia es de <strong>${margen.toFixed(1)}%</strong>.</p><p>Se recomienda al menos 10% de margen.</p>`,
                    timer: 4000,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false
                });
            }
        }
    });
}
</script>

<!-- ‚ö†Ô∏è AGREGAR ESTILOS ADICIONALES PARA POPUP GRANDE -->
<style>
.swal2-popup-large {
    width: 600px !important;
    max-width: 90% !important;
}

.swal2-popup-large .swal2-html-container {
    max-height: 500px;
    overflow-y: auto;
}
</style>
{% endblock %}